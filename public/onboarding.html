<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set up Cove</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/dash.css" />
  <style>
    /* ── Onboarding split layout ── */
    .ob-root { min-height: 100vh; display: flex; flex-direction: column; background: #F8F8FA; }

    .ob-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 2.5rem; height: 64px;
      background: #fff; border-bottom: 1px solid #E4E4E7;
      flex-shrink: 0; position: sticky; top: 0; z-index: 10;
    }
    .ob-topbar-steps {
      display: flex; align-items: center; gap: 8px;
    }
    .ob-step-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #E4E4E7; transition: all .25s;
    }
    .ob-step-dot.active { background: #2563EB; width: 28px; border-radius: 4px; }
    .ob-step-dot.done { background: #10B981; }

    .ob-split {
      flex: 1; display: grid;
      grid-template-columns: 1fr 520px;
      min-height: calc(100vh - 64px);
    }

    /* ── Left: form content ── */
    .ob-content {
      display: flex; flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
      overflow-y: auto;
      background: #fff;
    }
    .ob-form-inner { width: 100%; max-width: 440px; }
    .ob-content > * { max-width: 440px; width: 100%; }
    .ob-step-label {
      font-size: .68rem; font-weight: 700; letter-spacing: .12em;
      text-transform: uppercase; color: #2563EB; margin-bottom: .85rem;
    }
    .ob-heading {
      font-size: 2rem; font-weight: 800; letter-spacing: -.04em;
      color: #18181B; line-height: 1.15; margin-bottom: .6rem;
    }
    .ob-sub {
      font-size: .9rem; color: #71717A; line-height: 1.65;
      margin-bottom: 1.75rem;
    }

    .ob-fields { display: flex; flex-direction: column; gap: 1.25rem; }
    .ob-field label {
      display: block; font-size: .83rem; font-weight: 600;
      color: #3F3F46; margin-bottom: .45rem;
    }
    .ob-field label .optional { font-weight: 400; color: #A1A1AA; margin-left: .3rem; }
    .ob-field input, .ob-field textarea {
      width: 100%; padding: .875rem 1rem;
      font-size: 1rem; font-family: inherit;
      background: #fff; color: #18181B;
      border: 1.5px solid #E4E4E7; border-radius: 10px;
      transition: border-color .15s, box-shadow .15s;
      outline: none;
    }
    .ob-field input:focus, .ob-field textarea:focus {
      border-color: #2563EB;
      box-shadow: 0 0 0 3px rgba(37,99,235,.1);
    }
    .ob-field textarea { resize: vertical; min-height: 110px; line-height: 1.6; }
    .ob-field-hint { font-size: .8rem; color: #A1A1AA; margin-top: .4rem; line-height: 1.5; }

    .ob-actions {
      display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; margin-top: 2rem;
    }
    .ob-actions--right { justify-content: flex-end; }

    .ob-error {
      font-size: .85rem; color: #EF4444;
      background: #FEF2F2; border: 1px solid #FECACA;
      border-radius: 8px; padding: .6rem .85rem;
      margin-top: 1rem; display: none;
    }
    .ob-error.visible { display: block; }

    /* ── Right: marketing sidebar ── */
    .ob-sidebar {
      background: #0F172A;
      display: flex; flex-direction: column;
      padding: 3.5rem 3.5rem;
      position: sticky; top: 64px;
      height: calc(100vh - 64px);
      overflow-y: auto;
    }
    .ob-sidebar-badge {
      display: inline-flex; align-items: center; gap: .45rem;
      font-size: .65rem; font-weight: 700; letter-spacing: .12em;
      text-transform: uppercase; color: #06B6D4;
      margin-bottom: 1.5rem;
    }
    .ob-sidebar-badge-dot {
      width: 5px; height: 5px; border-radius: 50%;
      background: #06B6D4; box-shadow: 0 0 6px #06B6D4;
      animation: pulse-dot 2s ease-in-out infinite;
    }
    @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.7)} }

    .ob-sidebar h2 {
      font-size: 1.6rem; font-weight: 800; letter-spacing: -.04em;
      color: #fff; line-height: 1.2; margin-bottom: .65rem;
    }
    .ob-sidebar-sub {
      font-size: .85rem; color: rgba(255,255,255,.38);
      line-height: 1.6; margin-bottom: 1.5rem;
    }

    .ob-stat-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: .6rem;
      margin-bottom: 1.5rem;
    }
    .ob-stat {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 10px; padding: .85rem 1rem;
    }
    .ob-stat strong {
      display: block; font-size: 1.65rem; font-weight: 900;
      letter-spacing: -.05em; color: #fff; line-height: 1;
      margin-bottom: .2rem;
    }
    .ob-stat span { font-size: .65rem; color: rgba(255,255,255,.28); line-height: 1.4; text-transform: uppercase; letter-spacing: .07em; }

    .ob-bullets { display: flex; flex-direction: column; gap: .5rem; margin-bottom: 1.5rem; }
    .ob-bullet {
      display: flex; align-items: center; gap: .65rem;
      font-size: .82rem; color: rgba(255,255,255,.45); line-height: 1.45;
    }
    .ob-bullet-icon {
      width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0;
      display: grid; place-items: center;
      background: rgba(16,185,129,.15); color: #10B981;
    }
    .ob-bullet-icon--blue { background: rgba(37,99,235,.15); color: #60A5FA; }

    .ob-sms-preview {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 12px; padding: .9rem 1rem;
      margin-top: auto; display: flex; flex-direction: column; gap: .5rem;
    }
    .ob-sms-label {
      font-size: .6rem; font-weight: 700; letter-spacing: .1em;
      text-transform: uppercase; color: rgba(255,255,255,.18);
      margin-bottom: .05rem;
    }
    .ob-bubble {
      font-size: .8rem; line-height: 1.5; padding: .45rem .7rem;
      border-radius: 12px; width: fit-content; max-width: 92%;
    }
    .ob-bubble--recv {
      background: rgba(255,255,255,.07); color: rgba(255,255,255,.75);
      border-bottom-left-radius: 3px; margin-right: auto;
    }
    .ob-bubble--sent {
      background: #2563EB; color: #fff; font-weight: 600;
      border-bottom-right-radius: 3px; margin-left: auto;
    }

    .ob-guarantee {
      display: flex; align-items: center; gap: .55rem;
      margin-top: 1rem; padding-top: 1rem;
      font-size: .75rem; color: rgba(255,255,255,.22);
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .ob-guarantee svg { color: rgba(255,255,255,.15); flex-shrink: 0; }

    /* ── AI loading state ── */
    .ob-ai-loading {
      display: flex; flex-direction: column;
      gap: 1.5rem; padding: 1.5rem 0;
    }
    .ob-ai-loading-header { display: flex; align-items: center; gap: 1rem; }
    .ob-ai-spinner {
      width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
      border: 2.5px solid #E4E4E7; border-top-color: #2563EB;
      animation: spin .75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .ob-ai-loading-text { font-size: 1.1rem; font-weight: 700; color: #18181B; letter-spacing: -.02em; }
    .ob-ai-loading-sub { font-size: .875rem; color: #71717A; margin-top: .15rem; }
    .ob-ai-loading-steps { display: flex; flex-direction: column; gap: .5rem; }
    .ob-ai-loading-step {
      font-size: .875rem; color: #A1A1AA;
      display: flex; align-items: center; gap: .65rem;
      padding: .6rem .9rem; border-radius: 8px; transition: all .2s;
    }
    .ob-ai-loading-step.active { color: #2563EB; font-weight: 600; background: #EFF6FF; }
    .ob-ai-loading-step.done { color: #10B981; }
    .ob-ai-loading-step.done svg { display: block; }
    .ob-ai-loading-step svg { display: none; }

    /* ── Flow question cards ── */
    .ob-flow-questions { display: flex; flex-direction: column; gap: .65rem; margin-bottom: 1rem; }

    .ob-q-card {
      background: #fff; border: 1.5px solid #E4E4E7; border-radius: 12px;
      overflow: hidden; transition: border-color .15s, box-shadow .15s;
    }
    .ob-q-card:focus-within { border-color: #2563EB; box-shadow: 0 0 0 3px rgba(37,99,235,.08); }

    .ob-q-card-top {
      display: flex; align-items: flex-start; gap: .75rem;
      padding: .85rem 1rem .85rem;
    }
    .ob-q-num-badge {
      width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0; margin-top: 2px;
      background: #E4E4E7; color: #71717A; font-size: .7rem; font-weight: 800;
      display: grid; place-items: center;
    }
    .ob-q-card:focus-within .ob-q-num-badge { background: #DBEAFE; color: #2563EB; }
    .ob-q-textarea {
      flex: 1; border: none; outline: none;
      font-size: .9rem; font-family: inherit;
      color: #18181B; line-height: 1.6; resize: none;
      background: transparent; overflow: hidden;
      padding: 0; min-height: unset;
    }
    .ob-q-textarea::placeholder { color: #C4C4C8; }

    .ob-q-options {
      display: flex; flex-wrap: wrap; gap: .35rem;
      padding: 0 1rem .75rem 3.1rem;
    }
    .ob-q-chip {
      display: inline-flex; align-items: center; gap: .25rem;
      font-size: .73rem; font-weight: 600; padding: .2rem .55rem;
      border-radius: 6px; background: #F4F4F5; color: #52525B; border: 1px solid #E4E4E7;
      font-family: 'SF Mono','Fira Code',monospace;
    }
    .ob-q-chip--free { background: #F0FDF4; border-color: #BBF7D0; color: #16A34A; font-family: inherit; font-weight: 500; }

    .ob-step2-hint {
      display: flex; align-items: center; gap: .5rem;
      font-size: .78rem; color: #A1A1AA; margin-bottom: .85rem;
      background: #F8F8FA; border-radius: 8px; padding: .5rem .75rem;
    }
    .ob-step2-hint svg { color: #2563EB; flex-shrink: 0; }

    .ob-regen-row { display: flex; align-items: center; gap: .75rem; margin-top: .75rem; }
    .ob-regen-btn {
      display: inline-flex; align-items: center; gap: .4rem;
      font-size: .8rem; font-weight: 600; color: #2563EB;
      background: #EFF6FF; border: 1.5px solid #BFDBFE;
      border-radius: 8px; padding: .45rem .85rem; cursor: pointer;
      font-family: inherit; transition: background .15s;
    }
    .ob-regen-btn:hover { background: #DBEAFE; }
    .ob-regen-note { font-size: .78rem; color: #A1A1AA; }

    /* ── Payment card ── */
    .ob-plan-card {
      background: #fff; border: 1.5px solid #E4E4E7; border-radius: 16px;
      overflow: hidden; margin-bottom: 1.75rem;
      box-shadow: 0 4px 16px rgba(0,0,0,.06);
    }
    .ob-plan-top {
      background: linear-gradient(135deg, #1D4ED8 0%, #0891B2 100%);
      padding: 2rem 1.75rem;
    }
    .ob-plan-price {
      font-size: 3rem; font-weight: 900; letter-spacing: -.05em;
      color: #fff; line-height: 1;
    }
    .ob-plan-price span { font-size: 1.1rem; font-weight: 500; color: rgba(255,255,255,.65); }
    .ob-plan-note { font-size: .85rem; color: rgba(255,255,255,.6); margin-top: .4rem; }
    .ob-plan-items {
      padding: 1.35rem 1.75rem; display: flex; flex-direction: column; gap: .8rem;
    }
    .ob-plan-item {
      display: flex; align-items: center; gap: .7rem;
      font-size: .9rem; color: #3F3F46;
    }
    .ob-plan-item svg { color: #10B981; flex-shrink: 0; }

    /* ── Complete step ── */
    .ob-complete-icon {
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, #2563EB, #06B6D4);
      display: grid; place-items: center; color: #fff;
      margin-bottom: 1.25rem;
      box-shadow: 0 8px 24px rgba(37,99,235,.25);
    }
    .cf-num-box {
      display: flex; align-items: center; justify-content: space-between;
      background: #fff; border: 1.5px solid #E4E4E7; border-radius: 12px;
      padding: 1rem 1.25rem; margin-bottom: 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,.04);
    }
    .cf-num-box-left { display: flex; align-items: center; gap: .75rem; }
    .cf-num-box-label { font-size: .72rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: #A1A1AA; margin-bottom: .2rem; }
    .cf-num-box-number { font-size: 1.35rem; font-weight: 800; letter-spacing: -.02em; color: #18181B; font-family: 'SF Mono','Fira Code',monospace; }
    .cf-num-box-icon { width: 38px; height: 38px; border-radius: 10px; background: #EFF6FF; display: grid; place-items: center; color: #2563EB; flex-shrink: 0; }
    .cf-num-loading { font-size: 1rem; font-weight: 600; color: #A1A1AA; font-family: inherit; }

    /* Carrier tabs */
    .cf-tabs { display: flex; gap: 6px; margin-bottom: 0; }
    .cf-tab {
      flex: 1; padding: .55rem .5rem; border-radius: 8px 8px 0 0;
      border: 1.5px solid #E4E4E7; border-bottom: none;
      background: #F4F4F5; color: #71717A;
      font-size: .8rem; font-weight: 600; cursor: pointer;
      font-family: inherit; text-align: center; transition: all .15s;
    }
    .cf-tab.active { background: #fff; color: #18181B; border-color: #E4E4E7; }
    .cf-tab-panels { border: 1.5px solid #E4E4E7; border-radius: 0 0 12px 12px; background: #fff; margin-bottom: 1.25rem; overflow: hidden; }
    .cf-panel { display: none; padding: 1.25rem; }
    .cf-panel.active { display: block; }
    .cf-panel-step { display: flex; align-items: flex-start; gap: .85rem; padding: .6rem 0; border-bottom: 1px solid #F4F4F5; }
    .cf-panel-step:last-child { border-bottom: none; padding-bottom: 0; }
    .cf-panel-num { width: 22px; height: 22px; border-radius: 50%; background: #2563EB; color: #fff; font-size: .7rem; font-weight: 800; display: grid; place-items: center; flex-shrink: 0; margin-top: 1px; }
    .cf-panel-text { font-size: .88rem; color: #3F3F46; line-height: 1.5; flex: 1; }
    .cf-panel-text strong { color: #18181B; }
    .cf-dial-btn {
      display: inline-flex; align-items: center; gap: .4rem; margin-top: .5rem;
      background: #EFF6FF; border: 1.5px solid #BFDBFE; border-radius: 8px;
      padding: .45rem .9rem; font-size: .82rem; font-weight: 700;
      color: #2563EB; font-family: 'SF Mono','Fira Code',monospace;
      text-decoration: none; cursor: pointer; letter-spacing: .03em;
      transition: background .15s;
    }
    .cf-dial-btn:hover { background: #DBEAFE; }
    .cf-dial-btn-icon { font-family: inherit; font-size: .75rem; opacity: .6; }

    .cf-code {
      display: inline-block; background: #F4F4F5; border: 1px solid #E4E4E7;
      border-radius: 6px; padding: .15rem .55rem;
      font-family: 'SF Mono', 'Fira Code', monospace; font-size: .82rem;
      color: #2563EB; font-weight: 600; letter-spacing: .02em;
    }

    .cf-test-block { border: 1.5px solid #E4E4E7; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; background: #fff; }
    .cf-test-title { font-size: .82rem; font-weight: 700; color: #3F3F46; margin-bottom: .65rem; }
    .cf-test-row { display: flex; gap: .6rem; margin-bottom: .5rem; }
    .cf-test-input { flex: 1; padding: .6rem .85rem; font-size: .9rem; font-family: inherit; border: 1.5px solid #E4E4E7; border-radius: 8px; background: #fff; color: #18181B; outline: none; }
    .cf-test-input:focus { border-color: #2563EB; }
    .cf-test-status { font-size: .82rem; font-weight: 600; min-height: 1.2rem; margin-bottom: .2rem; }
    .cf-test-status.success { color: #16A34A; }
    .cf-test-status.error { color: #DC2626; }
    .cf-test-note { font-size: .78rem; color: #A1A1AA; }

    .ob-info-banner {
      display: flex; align-items: flex-start; gap: .65rem;
      background: #F8FAFC; border: 1px solid #E4E4E7; border-radius: 10px;
      padding: .75rem 1rem; margin-top: 1rem;
      font-size: .82rem; color: #52525B; line-height: 1.5;
    }
    .ob-info-banner svg { flex-shrink: 0; margin-top: 1px; color: #A1A1AA; }

    /* ── Responsive ── */
    @media (max-width: 1200px) {
      .ob-split { grid-template-columns: 1fr 460px; }
      .ob-sidebar { padding: 3rem 3rem; }
    }
    @media (max-width: 1024px) {
      .ob-split { grid-template-columns: 1fr 400px; }
      .ob-sidebar { padding: 2.5rem 2.25rem; }
    }
    @media (max-width: 768px) {
      .ob-split { grid-template-columns: 1fr; }
      .ob-sidebar { display: none; }
      .ob-content { padding: 2rem 1.25rem; }
      .ob-heading { font-size: 1.7rem; }
    }
  </style>
</head>
<body class="ob-root">

  <header class="ob-topbar">
    <a href="/" class="cove-logo">
      <svg width="26" height="26" viewBox="0 0 28 28" fill="none">
        <rect width="28" height="28" rx="7" fill="url(#ob-lg)"/>
        <path d="M18 9.5a5.5 5.5 0 1 0 0 9" stroke="#fff" stroke-width="2.4" stroke-linecap="round" fill="none"/>
        <defs><linearGradient id="ob-lg" x1="0" y1="0" x2="28" y2="28"><stop stop-color="#2563eb"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs>
      </svg>
      <span>cove</span>
    </a>
    <div class="ob-topbar-steps" id="step-dots">
      <div class="ob-step-dot" data-step="1"></div>
      <div class="ob-step-dot" data-step="2"></div>
      <div class="ob-step-dot" data-step="3"></div>
      <div class="ob-step-dot" data-step="4"></div>
    </div>
    <div style="width:80px"></div>
  </header>

  <div class="ob-split">

    <!-- ── Left: form panel ── -->
    <main class="ob-content" id="ob-content">

      <!-- Step 1: Business info -->
      <div id="step-1" class="ob-form-inner">
        <div class="ob-step-label">Step 1 of 4</div>
        <h1 class="ob-heading">Tell us about your business.</h1>
        <p class="ob-sub">The more specific you are, the better Cove's AI can write your qualification questions.</p>

        <div class="ob-fields">
          <div class="ob-field">
            <label for="biz-name">Business name</label>
            <input type="text" id="biz-name" placeholder="Bay Plumbing" autocomplete="organization" />
          </div>
          <div class="ob-field">
            <label for="biz-desc">What do you do?</label>
            <textarea id="biz-desc" placeholder="e.g. We're a residential plumbing business in Sydney. We handle emergency call-outs, blocked drains, hot water systems and general repairs. Mostly homeowners and landlords." rows="4"></textarea>
            <div class="ob-field-hint">Be specific — include what types of jobs you do and who your typical customer is.</div>
          </div>
          <div class="ob-field">
            <label for="biz-booking">Online booking link <span class="optional">(optional)</span></label>
            <input type="url" id="biz-booking" placeholder="https://book.yoursite.com.au" autocomplete="url" />
          </div>
        </div>

        <div id="step1-error" class="ob-error"></div>

        <div class="ob-actions ob-actions--right" style="margin-top:2rem">
          <button class="btn btn--primary btn--lg" id="step1-next">
            Generate my questions
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Step 2: AI flow -->
      <div id="step-2" class="ob-form-inner hidden">
        <div class="ob-step-label">Step 2 of 4</div>
        <h1 class="ob-heading">Your lead questions.</h1>
        <p class="ob-sub">AI wrote these for your business. Every missed caller gets asked these by SMS — edit any line directly.</p>

        <!-- Loading state -->
        <div id="flow-loading">
          <div class="ob-ai-loading">
            <div class="ob-ai-loading-header">
              <div class="ob-ai-spinner"></div>
              <div>
                <div class="ob-ai-loading-text">Writing your questions…</div>
                <div class="ob-ai-loading-sub">Takes about 10 seconds</div>
              </div>
            </div>
            <div class="ob-ai-loading-steps">
              <div class="ob-ai-loading-step active" id="ai-step-1">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                Reading your business description
              </div>
              <div class="ob-ai-loading-step" id="ai-step-2">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                Crafting qualification questions
              </div>
              <div class="ob-ai-loading-step" id="ai-step-3">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                Formatting your SMS flow
              </div>
            </div>
          </div>
        </div>

        <!-- Generated flow -->
        <div id="flow-content" class="hidden">
          <div class="ob-step2-hint">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Click any question to edit the text. The options (A / B / C) are sent to your customer as reply choices.
          </div>
          <div class="ob-flow-questions" id="flow-questions"></div>
          <div class="ob-regen-row">
            <button class="ob-regen-btn" id="regen-btn" type="button">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
              Regenerate
            </button>
            <span class="ob-regen-note">Not happy with these? Rewrite with AI.</span>
          </div>
        </div>

        <div id="step2-error" class="ob-error"></div>

        <div class="ob-actions" style="margin-top:1.5rem">
          <button class="btn btn--ghost" id="step2-back" type="button">← Back</button>
          <button class="btn btn--primary btn--lg" id="step2-next" type="button">
            Looks good
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Step 3: Notifications -->
      <div id="step-3" class="ob-form-inner hidden">
        <div class="ob-step-label">Step 3 of 4</div>
        <h1 class="ob-heading">Where do lead summaries go?</h1>
        <p class="ob-sub">When someone completes the flow you'll get a summary — their name, what they need, and how urgent. Where should we send it?</p>

        <div class="ob-fields">
          <div class="ob-field">
            <label for="notify-phone">Your mobile number</label>
            <input type="tel" id="notify-phone" placeholder="+61 412 345 678" autocomplete="tel" />
            <div class="ob-field-hint">Summaries sent here by SMS. This is your personal number, not your business number.</div>
          </div>
          <div class="ob-field">
            <label for="notify-email">Email address <span class="optional">(optional)</span></label>
            <input type="email" id="notify-email" placeholder="you@business.com.au" autocomplete="email" />
            <div class="ob-field-hint">Also receive summaries by email. Handy for end-of-day review.</div>
          </div>
        </div>

        <div id="step3-error" class="ob-error"></div>

        <div class="ob-actions" style="margin-top:2rem">
          <button class="btn btn--ghost" id="step3-back" type="button">← Back</button>
          <button class="btn btn--primary btn--lg" id="step3-next" type="button">
            Save &amp; continue
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Step 4: Payment -->
      <div id="step-4" class="ob-form-inner hidden">
        <div class="ob-step-label">Last step</div>
        <h1 class="ob-heading">Activate your account.</h1>
        <p class="ob-sub">Add your card to go live. If Cove doesn't pay for itself in 30 days, we'll refund you in full — no questions.</p>

        <div class="ob-plan-card">
          <div class="ob-plan-top">
            <div class="ob-plan-price">$49<span>/month</span></div>
            <div class="ob-plan-note">Cancel anytime · 30-day money-back guarantee</div>
          </div>
          <div class="ob-plan-items">
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>Your own dedicated AU SMS number</div>
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>Texts leads back in 10 seconds, 24/7</div>
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>AI-qualified lead summaries to your phone</div>
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>Webhook &amp; CRM integrations included</div>
          </div>
        </div>

        <div id="step4-error" class="ob-error"></div>

        <div class="ob-actions" style="margin-top:.5rem">
          <button class="btn btn--ghost" id="step4-back" type="button">← Back</button>
          <button class="btn btn--primary btn--lg" id="step4-pay" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            Add payment details
          </button>
        </div>

        <p style="font-size:.78rem;color:#A1A1AA;text-align:center;margin-top:1rem">
          Secured by Stripe &middot; SSL encrypted &middot; Cancel anytime
        </p>
      </div>

      <!-- Complete: call forwarding -->
      <div id="step-complete" class="ob-form-inner hidden">
        <div class="ob-complete-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <h1 class="ob-heading">Set up call forwarding.</h1>
        <p class="ob-sub">Forward missed calls on your mobile to your Cove number. Takes 30 seconds. After that, every missed call sends an automatic text to your lead.</p>

        <!-- Number display -->
        <div class="cf-num-box">
          <div class="cf-num-box-left">
            <div class="cf-num-box-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </div>
            <div>
              <div class="cf-num-box-label">Your Cove number</div>
              <div class="cf-num-box-number" id="cf-number-text"><span class="cf-num-loading">Setting up…</span></div>
            </div>
          </div>
        </div>

        <!-- Carrier tabs -->
        <div class="cf-tabs">
          <button class="cf-tab active" data-tab="telstra">Telstra</button>
          <button class="cf-tab" data-tab="optus">Optus</button>
          <button class="cf-tab" data-tab="vodafone">Vodafone</button>
          <button class="cf-tab" data-tab="other">Other</button>
        </div>
        <div class="cf-tab-panels">

          <!-- Telstra -->
          <div class="cf-panel active" id="panel-telstra">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open your <strong>Phone app</strong> and go to the dial pad</div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">
                Dial this code and tap <strong>Call</strong>
                <br><a class="cf-dial-btn" id="code-1-link" href="#"><span id="code-1">**61*+XXXXXXXXXX*11*20#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">3</div>
              <div class="cf-panel-text">You'll hear a confirmation tone. Done — call forwarding is active.</div>
            </div>
          </div>

          <!-- Optus -->
          <div class="cf-panel" id="panel-optus">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open <strong>My Optus app</strong> → tap <strong>Manage</strong> → <strong>Call divert</strong></div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">Under <strong>When unanswered</strong>, enter your Cove number in local format:<br>
                <span class="cf-code" id="carrier-number-local" style="margin-top:.35rem;display:inline-block">loading…</span>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">3</div>
              <div class="cf-panel-text">Tap <strong>Save</strong>. Or try the dial code:<br>
                <a class="cf-dial-btn" id="code-2-link" href="#" style="margin-top:.35rem"><span id="code-2">**61*+XXXXXXXXXX#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
          </div>

          <!-- Vodafone -->
          <div class="cf-panel" id="panel-vodafone">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open <strong>My Vodafone app</strong> → <strong>Services</strong> → <strong>Call divert</strong></div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">Set <strong>Divert when unanswered</strong> to your Cove number:<br>
                <span class="cf-code" id="carrier-number" style="margin-top:.35rem;display:inline-block">loading…</span>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">3</div>
              <div class="cf-panel-text">Save. Or dial from the keypad:<br>
                <a class="cf-dial-btn" id="code-3-link" href="#" style="margin-top:.35rem"><span id="code-3">*61*+XXXXXXXXXX*11*20#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
          </div>

          <!-- Other -->
          <div class="cf-panel" id="panel-other">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open your <strong>Phone app</strong> dial pad and enter this code, then tap <strong>Call</strong>:<br>
                <a class="cf-dial-btn" id="code-4-link" href="#" style="margin-top:.35rem"><span id="code-4">**61*+XXXXXXXXXX*11*20#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">If that fails, call your carrier and say: <em>"Set call divert when unanswered to <span id="other-number">your Cove number</span>"</em></div>
            </div>
          </div>

        </div>

        <!-- Test SMS -->
        <div class="cf-test-block">
          <div class="cf-test-title">Test it — send yourself an SMS</div>
          <div class="cf-test-row">
            <input type="tel" id="cf-test-phone" placeholder="Your mobile e.g. 0412 345 678" class="cf-test-input" />
            <button class="btn btn--primary btn--sm" id="cf-test-btn" type="button">Send</button>
          </div>
          <div class="cf-test-status" id="cf-test-status"></div>
          <div class="cf-test-note">If you receive it, your Cove number is working.</div>
        </div>

        <div class="ob-info-banner">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
          <span>Your number is saved in your dashboard. Questions? <a href="mailto:hello@coveplatform.com" style="color:#2563EB;font-weight:600">hello@coveplatform.com</a></span>
        </div>

        <div class="ob-actions ob-actions--right" style="margin-top:1.75rem">
          <button class="btn btn--primary btn--lg" id="go-dashboard" type="button">
            Go to dashboard
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

    </main>

    <!-- ── Right: marketing sidebar ── -->
    <aside class="ob-sidebar" id="ob-sidebar">

      <!-- Default sidebar (steps 1-3) -->
      <div id="sidebar-default" style="display:flex;flex-direction:column;height:100%">
        <div class="ob-sidebar-badge">
          <span class="ob-sidebar-badge-dot"></span>
          Always on
        </div>

        <div style="font-size:2.8rem;font-weight:900;letter-spacing:-.05em;color:#fff;line-height:1.05;margin-bottom:.9rem">
          Every missed call,<br/>texted back<br/><span style="color:#06B6D4">in 10 seconds.</span>
        </div>

        <div style="font-size:.9rem;color:rgba(255,255,255,.35);line-height:1.6;margin-bottom:2rem">
          While you're on the job, Cove handles every missed caller automatically.
        </div>

        <!-- SMS conversation mockup -->
        <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:1.5rem;margin-bottom:1.25rem">
          <div style="font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.2);margin-bottom:1rem">What your customer receives</div>
          <div style="display:flex;flex-direction:column;gap:.75rem">
            <div style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.82);font-size:.88rem;line-height:1.6;padding:.7rem 1rem;border-radius:16px;border-bottom-left-radius:3px;max-width:90%">
              Hi Sam — thanks for calling Bay Plumbing. How urgent is your issue?<br/><br/>A) Emergency &nbsp;·&nbsp; B) Same day &nbsp;·&nbsp; C) Not urgent
            </div>
            <div style="background:#2563EB;color:#fff;font-weight:600;font-size:.88rem;padding:.6rem 1rem;border-radius:16px;border-bottom-right-radius:3px;margin-left:auto">
              A
            </div>
            <div style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.82);font-size:.88rem;line-height:1.6;padding:.7rem 1rem;border-radius:16px;border-bottom-left-radius:3px;max-width:90%">
              Got it — emergency. We'll call you back shortly.
            </div>
          </div>
        </div>

        <!-- Stats row -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.6rem;margin-bottom:auto">
          <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:.9rem .75rem;text-align:center">
            <div style="font-size:1.75rem;font-weight:900;color:#fff;letter-spacing:-.04em;line-height:1">10s</div>
            <div style="font-size:.62rem;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.07em;margin-top:.3rem">text-back</div>
          </div>
          <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:.9rem .75rem;text-align:center">
            <div style="font-size:1.75rem;font-weight:900;color:#fff;letter-spacing:-.04em;line-height:1">24/7</div>
            <div style="font-size:.62rem;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.07em;margin-top:.3rem">always on</div>
          </div>
          <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:.9rem .75rem;text-align:center">
            <div style="font-size:1.75rem;font-weight:900;color:#fff;letter-spacing:-.04em;line-height:1">$49</div>
            <div style="font-size:.62rem;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.07em;margin-top:.3rem">/ month</div>
          </div>
        </div>

        <!-- Demo widget -->
        <div style="margin-top:1.5rem;background:rgba(37,99,235,.15);border:1px solid rgba(37,99,235,.35);border-radius:16px;padding:1.25rem 1.5rem">
          <div style="font-size:.78rem;font-weight:700;color:rgba(255,255,255,.7);margin-bottom:.5rem">Try it — get the real SMS</div>
          <div style="display:flex;gap:.5rem">
            <input id="ob-demo-phone" type="tel" placeholder="0412 345 678" style="flex:1;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:.55rem .85rem;font-size:.88rem;color:#fff;font-family:inherit;outline:none" />
            <button id="ob-demo-btn" type="button" onclick="obSendDemo()" style="background:#2563EB;color:#fff;border:none;border-radius:8px;padding:.55rem 1rem;font-size:.82rem;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap">Send demo</button>
          </div>
          <div id="ob-demo-status" style="font-size:.78rem;margin-top:.5rem;min-height:1.1rem;color:rgba(255,255,255,.5)"></div>
        </div>

        <div style="display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:rgba(255,255,255,.18);padding-top:1.25rem;margin-top:1.25rem;border-top:1px solid rgba(255,255,255,.06)">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          30-day money-back guarantee
        </div>
      </div>

      <!-- Sidebar for step 2: live phone preview -->
      <div id="sidebar-step2" style="display:none;flex-direction:column;height:100%">
        <div class="ob-sidebar-badge">
          <span class="ob-sidebar-badge-dot"></span>
          Live preview
        </div>

        <div style="font-size:1.6rem;font-weight:900;letter-spacing:-.04em;color:#fff;line-height:1.15;margin-bottom:.6rem">
          What your customer sees.
        </div>
        <div style="font-size:.85rem;color:rgba(255,255,255,.35);line-height:1.6;margin-bottom:1.75rem">
          This is the exact SMS conversation they receive within 10 seconds of a missed call.
        </div>

        <!-- Phone shell -->
        <div style="flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:1.25rem;display:flex;flex-direction:column;overflow:hidden">
          <!-- Fake SMS header -->
          <div style="display:flex;align-items:center;gap:.65rem;padding-bottom:.85rem;margin-bottom:.85rem;border-bottom:1px solid rgba(255,255,255,.07)">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#2563eb,#06b6d4);display:grid;place-items:center;font-size:.7rem;font-weight:800;color:#fff" id="sidebar-step2-avatar">BP</div>
            <div>
              <div style="font-size:.82rem;font-weight:700;color:#fff" id="sidebar-step2-name">Bay Plumbing</div>
              <div style="font-size:.68rem;color:rgba(255,255,255,.3)">SMS · Delivered instantly</div>
            </div>
          </div>

          <!-- Messages — populated by JS -->
          <div id="sidebar-step2-msgs" style="display:flex;flex-direction:column;gap:.5rem;overflow-y:auto;flex:1">
            <div style="background:rgba(255,255,255,.05);color:rgba(255,255,255,.3);font-size:.78rem;padding:.65rem .85rem;border-radius:10px;text-align:center">
              Your questions will appear here as they load…
            </div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:rgba(255,255,255,.18);padding-top:1.1rem;margin-top:1.1rem;border-top:1px solid rgba(255,255,255,.06)">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          Updates live as you edit questions above
        </div>
      </div>

      <!-- Sidebar for payment step -->
      <div id="sidebar-payment" style="display:none;flex-direction:column;height:100%">
        <div class="ob-sidebar-badge">
          <span class="ob-sidebar-badge-dot"></span>
          Last step
        </div>

        <div style="font-size:2.2rem;font-weight:900;letter-spacing:-.05em;color:#fff;line-height:1.1;margin-bottom:1rem">
          One job covers<br/><span style="color:#06B6D4">6 months.</span>
        </div>

        <div style="font-size:.85rem;color:rgba(255,255,255,.35);line-height:1.6;margin-bottom:2rem">
          Average trade job is $400+. Cove is $49/mo. The maths is simple.
        </div>

        <div style="flex:1;display:flex;flex-direction:column;justify-content:flex-end">
          <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:1.5rem;margin-bottom:1.25rem">
            <div style="font-size:3rem;font-weight:900;letter-spacing:-.06em;color:#fff;line-height:1">$49</div>
            <div style="font-size:.8rem;color:rgba(255,255,255,.35);margin-top:.3rem;margin-bottom:1.5rem">per month · cancel anytime</div>
            <div style="display:flex;flex-direction:column;gap:.6rem">
              <div style="display:flex;align-items:center;gap:.6rem;font-size:.82rem;color:rgba(255,255,255,.55)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                AU number activated immediately
              </div>
              <div style="display:flex;align-items:center;gap:.6rem;font-size:.82rem;color:rgba(255,255,255,.55)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                No setup fee, no contracts
              </div>
              <div style="display:flex;align-items:center;gap:.6rem;font-size:.82rem;color:rgba(255,255,255,.55)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                30-day money-back guarantee
              </div>
            </div>
          </div>

          <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:1.1rem 1.25rem">
            <div style="font-size:.82rem;color:rgba(255,255,255,.6);font-style:italic;line-height:1.6;margin-bottom:.5rem">"Leads are qualified before I finish the current job."</div>
            <div style="font-size:.72rem;font-weight:600;color:rgba(255,255,255,.25)">Mark T. — Bay Area Plumbing</div>
          </div>

          <div style="display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:rgba(255,255,255,.2);padding-top:1rem;margin-top:1rem;border-top:1px solid rgba(255,255,255,.06)">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Secured by Stripe · SSL encrypted
          </div>
        </div>
      </div>

    </aside>
  </div>

  <script>
    let currentStep = 1;
    let flowConfig = null;
    let bizData = {};

    function showStep(n) {
      document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.add('hidden'));
      const el = document.getElementById('step-' + n);
      if (el) el.classList.remove('hidden');

      // Update dots
      const stepNum = typeof n === 'number' ? n : 5;
      document.querySelectorAll('.ob-step-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'done');
        const s = i + 1;
        if (s < stepNum) dot.classList.add('done');
        else if (s === stepNum) dot.classList.add('active');
      });
      currentStep = n;

      // Swap sidebar
      const sidebarDefault  = document.getElementById('sidebar-default');
      const sidebarStep2    = document.getElementById('sidebar-step2');
      const sidebarPayment  = document.getElementById('sidebar-payment');
      sidebarDefault.style.display  = 'none';
      sidebarStep2.style.display    = 'none';
      sidebarPayment.style.display  = 'none';
      if (n === 2) {
        sidebarStep2.style.display = 'flex';
        // Update avatar initials and name
        const name = bizData.businessName || '';
        const initials = name.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase() || 'BP';
        const av = document.getElementById('sidebar-step2-avatar');
        const nm = document.getElementById('sidebar-step2-name');
        if (av) av.textContent = initials;
        if (nm) nm.textContent = name || 'Your business';
      } else if (n === 4) {
        sidebarPayment.style.display = 'flex';
      } else {
        sidebarDefault.style.display = 'flex';
      }

      // Scroll form to top
      document.getElementById('ob-content').scrollTo(0, 0);
    }

    // ─── Init ───
    const params = new URLSearchParams(location.search);
    if (params.get('step') === 'complete') {
      showStep('complete');
      // Try to fill number immediately from session, then fall back to polling
      fetch('/api/auth/me').then(r => r.json()).then(data => {
        const num = data.business?.twilio_from_number;
        if (num) { fillNumber(num); }
        else { loadNumber(); }
      }).catch(() => loadNumber());
    } else if (params.get('step') === 'billing') {
      showStep(4);
    } else {
      fetch('/api/auth/me')
        .then(r => r.json())
        .then(data => {
          if (!data.ok) { location.href = '/login'; return; }
          if (data.user?.onboarding_complete && data.business?.is_active) {
            location.href = '/dashboard'; return;
          }
          if (data.business?.name) {
            bizData.businessName = data.business.name;
            document.getElementById('biz-name').value = data.business.name;
          }
          showStep(1);
        })
        .catch(() => location.href = '/login');
    }

    let _loadNumberAttempts = 0;
    let _provisionAttempted = false;

    function fillNumber(num) {
      const numBox = document.getElementById('cf-number-text');
      if (numBox) numBox.textContent = num;

      const localNum = num.startsWith('+61') ? '0' + num.slice(3) : num;
      const intlNum  = num.startsWith('+')   ? '0011' + num.slice(1) : num;

      const codes = {
        'code-1': `**61*${num}*11*20#`,
        'code-2': `**61*${num}#`,
        'code-3': `*61*${num}*11*20#`,
        'code-4': `**61*${intlNum}*11*20#`,
      };
      for (const [id, code] of Object.entries(codes)) {
        const el = document.getElementById(id);
        if (el) el.textContent = code;
        const link = document.getElementById(id + '-link');
        if (link) link.href = `tel:${encodeURIComponent(code)}`;
      }
      const cn = document.getElementById('carrier-number');
      if (cn) cn.textContent = num;
      const ln = document.getElementById('carrier-number-local');
      if (ln) ln.textContent = localNum;
      const on = document.getElementById('other-number');
      if (on) on.textContent = num;
    }

    // ─── Carrier tabs ───
    document.querySelectorAll('.cf-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.cf-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.cf-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        const panel = document.getElementById('panel-' + tab.dataset.tab);
        if (panel) panel.classList.add('active');
      });
    });

    async function loadNumber() {
      _loadNumberAttempts++;
      const numText = document.getElementById('cf-number-text');
      try {
        const data = await fetch('/api/auth/me').then(r => r.json());
        const num = data.business?.twilio_from_number;
        if (num) { fillNumber(num); return; }
      } catch(e) { /* network error, retry */ }

      // After 3 polls (~9s) with no number, auto-trigger provision once
      if (!_provisionAttempted && _loadNumberAttempts >= 3) {
        _provisionAttempted = true;
        if (numText) numText.textContent = 'Provisioning your number…';
        try {
          const r = await fetch('/api/auth/provision-number', { method: 'POST' }).then(r => r.json());
          if (r.ok && r.number) { fillNumber(r.number); return; }
        } catch(e) { /* fall through to retry loop */ }
      }

      if (_loadNumberAttempts < 15) {
        const secs = _loadNumberAttempts * 3;
        if (numText) numText.textContent = `Setting up your number… (${secs}s)`;
        setTimeout(loadNumber, 3000);
      } else {
        if (numText) numText.innerHTML = `Could not provision automatically — <a href="#" id="retry-provision" style="color:#2563EB;font-weight:600">try again</a> or <a href="mailto:hello@coveplatform.com" style="color:#2563EB">contact support</a>.`;
        document.getElementById('retry-provision')?.addEventListener('click', async (e) => {
          e.preventDefault();
          _loadNumberAttempts = 0; _provisionAttempted = false;
          if (numText) numText.textContent = 'Retrying…';
          loadNumber();
        });
      }
    }

    // ─── Test SMS ───
    const testBtn = document.getElementById('cf-test-btn');
    if (testBtn) {
      testBtn.addEventListener('click', async () => {
        const phone = document.getElementById('cf-test-phone').value.trim();
        const status = document.getElementById('cf-test-status');
        if (!phone) { status.textContent = 'Enter your mobile number first.'; status.className = 'cf-test-status error'; return; }
        testBtn.disabled = true; testBtn.textContent = 'Sending…';
        status.textContent = ''; status.className = 'cf-test-status';
        try {
          const res = await fetch('/api/demo/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, message: `✅ Cove is connected! Your call forwarding is set up correctly. Missed calls will now be texted back automatically.` })
          }).then(r => r.json());
          if (res.ok) {
            status.textContent = '✅ Test SMS sent! Check your phone — if you got it, you\'re all set.';
            status.className = 'cf-test-status success';
          } else {
            status.textContent = res.error || 'Could not send — check your number and try again.';
            status.className = 'cf-test-status error';
          }
        } catch(e) {
          status.textContent = 'Network error — try again.';
          status.className = 'cf-test-status error';
        }
        testBtn.disabled = false; testBtn.textContent = 'Send test SMS';
      });
    }

    // ─── AI loading animation ───
    function animateAISteps() {
      const steps = ['ai-step-1', 'ai-step-2', 'ai-step-3'];
      let i = 0;
      function advance() {
        if (i > 0) {
          const prev = document.getElementById(steps[i - 1]);
          if (prev) { prev.classList.remove('active'); prev.classList.add('done'); }
        }
        if (i < steps.length) {
          const cur = document.getElementById(steps[i]);
          if (cur) cur.classList.add('active');
          i++;
          if (i < steps.length) setTimeout(advance, 1200);
        }
      }
      // Reset
      steps.forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.classList.remove('active', 'done'); }
      });
      setTimeout(advance, 400);
    }

    // ─── Render flow questions ───
    function renderFlow(flow) {
      const container = document.getElementById('flow-questions');
      container.innerHTML = '';
      flow.steps.forEach((step, i) => {
        const div = document.createElement('div');
        div.className = 'ob-q-card';
        const opts = step.options.map(o =>
          `<span class="ob-q-chip">${o.value}) ${o.label}</span>`
        ).join('');
        div.innerHTML = `
          <div class="ob-q-card-top">
            <span class="ob-q-num-badge">${i + 1}</span>
            <textarea class="ob-q-textarea" rows="1" data-step="${i}">${step.question}</textarea>
          </div>
          <div class="ob-q-options">${opts}</div>
        `;
        const ta = div.querySelector('textarea');
        // Auto-height on load and on input
        const resize = () => { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; };
        ta.addEventListener('input', () => { resize(); updateSidebarPreview(); });
        requestAnimationFrame(resize);
        container.appendChild(div);
      });
      updateSidebarPreview();
    }

    // ─── Live phone preview in sidebar for step 2 ───
    function updateSidebarPreview() {
      const msgs = document.getElementById('sidebar-step2-msgs');
      if (!msgs) return;
      msgs.innerHTML = '';
      document.querySelectorAll('.ob-q-textarea').forEach(ta => {
        const q = ta.value.trim();
        if (!q) return;
        const card = ta.closest('.ob-q-card');
        const chips = [...card.querySelectorAll('.ob-q-chip')].map(c => c.textContent.trim()).join(' · ');
        const bubble = document.createElement('div');
        bubble.style.cssText = 'background:rgba(255,255,255,.08);color:rgba(255,255,255,.82);font-size:.78rem;line-height:1.55;padding:.5rem .75rem;border-radius:12px;border-bottom-left-radius:3px;margin-bottom:.5rem';
        bubble.textContent = chips ? `${q}\n${chips}` : q;
        bubble.style.whiteSpace = 'pre-line';
        msgs.appendChild(bubble);
      });
    }

    // ─── Step 1 → 2 ───
    document.getElementById('step1-next').addEventListener('click', async () => {
      const name = document.getElementById('biz-name').value.trim();
      const desc = document.getElementById('biz-desc').value.trim();
      const err = document.getElementById('step1-error');
      err.classList.remove('visible');

      if (!name) { err.textContent = 'Please enter your business name.'; err.classList.add('visible'); return; }
      if (!desc || desc.length < 20) { err.textContent = 'Please describe your business in a bit more detail (at least 20 characters).'; err.classList.add('visible'); return; }

      bizData = { ...bizData, businessName: name, description: desc, bookingLink: document.getElementById('biz-booking').value.trim() };

      const btn = document.getElementById('step1-next');
      btn.disabled = true;
      btn.textContent = 'Generating…';

      showStep(2);
      document.getElementById('flow-loading').classList.remove('hidden');
      document.getElementById('flow-content').classList.add('hidden');
      animateAISteps();

      const res = await fetch('/api/onboarding/generate-flow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ businessName: name, description: desc }),
      }).then(r => r.json());

      btn.disabled = false;
      btn.innerHTML = 'Generate my questions <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';

      document.getElementById('flow-loading').classList.add('hidden');

      if (res.ok) {
        flowConfig = res.flow;
        renderFlow(flowConfig);
        document.getElementById('flow-content').classList.remove('hidden');
      } else {
        const stepErr = document.getElementById('step2-error');
        stepErr.textContent = res.error || 'Could not generate questions. Please check your OpenAI key.';
        stepErr.classList.add('visible');
        document.getElementById('flow-content').classList.remove('hidden');
      }
    });

    document.getElementById('regen-btn').addEventListener('click', async () => {
      document.getElementById('flow-loading').classList.remove('hidden');
      document.getElementById('flow-content').classList.add('hidden');
      animateAISteps();

      const res = await fetch('/api/onboarding/generate-flow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ businessName: bizData.businessName, description: bizData.description }),
      }).then(r => r.json());

      document.getElementById('flow-loading').classList.add('hidden');
      if (res.ok) {
        flowConfig = res.flow;
        renderFlow(flowConfig);
      }
      document.getElementById('flow-content').classList.remove('hidden');
    });

    // ─── Step 2 → 3 ───
    document.getElementById('step2-back').addEventListener('click', () => showStep(1));
    document.getElementById('step2-next').addEventListener('click', () => {
      if (flowConfig) {
        document.querySelectorAll('.ob-q-textarea').forEach((ta, i) => {
          if (flowConfig.steps[i]) flowConfig.steps[i].question = ta.value.trim();
        });
        bizData.flowConfig = flowConfig;
      }
      showStep(3);
    });

    // ─── Step 3 → 4 ───
    document.getElementById('step3-back').addEventListener('click', () => showStep(2));
    document.getElementById('step3-next').addEventListener('click', async () => {
      const phone = document.getElementById('notify-phone').value.trim();
      const email = document.getElementById('notify-email').value.trim();
      const err = document.getElementById('step3-error');
      err.classList.remove('visible');

      if (!phone) { err.textContent = 'Please enter your mobile number.'; err.classList.add('visible'); return; }

      bizData = { ...bizData, notifyPhone: phone, notifyEmail: email };

      const btn = document.getElementById('step3-next');
      btn.disabled = true;
      btn.textContent = 'Saving…';

      const res = await fetch('/api/onboarding/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          businessName: bizData.businessName,
          flowConfig: bizData.flowConfig || null,
          notifyPhone: phone,
          notifyEmail: email || null,
          bookingLink: bizData.bookingLink || null,
        }),
      }).then(r => r.json());

      btn.disabled = false;
      btn.innerHTML = 'Save &amp; continue <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';

      if (res.ok) {
        showStep(4);
      } else {
        err.textContent = res.error || 'Could not save. Please try again.';
        err.classList.add('visible');
      }
    });

    // ─── Step 4 → Stripe (or free bypass in dev) ───
    document.getElementById('step4-back').addEventListener('click', () => showStep(3));

    async function startCheckout() {
      const btn = document.getElementById('step4-pay');
      const err = document.getElementById('step4-error');
      btn.disabled = true;
      btn.textContent = 'Setting up your account…';
      err.classList.remove('visible');

      const res = await fetch('/api/billing/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      }).then(r => r.json());

      if (res.ok && res.url) {
        location.href = res.url;
      } else {
        err.textContent = res.error || 'Could not start checkout. Please try again.';
        err.classList.add('visible');
        btn.disabled = false;
        btn.innerHTML = originalPayBtnHtml;
      }
    }

    const payBtn = document.getElementById('step4-pay');
    const originalPayBtnHtml = payBtn.innerHTML;

    // Check if Stripe is configured — update button label accordingly
    fetch('/api/config/stripe-mode').then(r => r.json()).then(res => {
      if (!res.stripeEnabled) {
        payBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Activate account (free trial)`;
        document.querySelector('#step-4 .ob-sub').textContent = 'Click below to activate your account and get your dedicated number set up.';
      }
    }).catch(() => {});

    payBtn.addEventListener('click', startCheckout);

    // ─── Complete → Dashboard ───
    document.getElementById('go-dashboard').addEventListener('click', () => {
      location.href = '/dashboard';
    });

    // ─── Sidebar demo widget ───
    async function obSendDemo() {
      const input = document.getElementById('ob-demo-phone');
      const btn   = document.getElementById('ob-demo-btn');
      const status = document.getElementById('ob-demo-status');
      const phone = input.value.trim();
      if (!phone) { status.textContent = 'Enter your mobile number first.'; status.style.color = '#FCA5A5'; return; }
      btn.disabled = true;
      btn.textContent = 'Sending…';
      status.textContent = '';
      try {
        const res = await fetch('/api/demo/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone }),
        }).then(r => r.json());
        if (res.ok) {
          status.textContent = '✓ SMS sent — reply to the questions!';
          status.style.color = '#6EE7B7';
          btn.textContent = 'Sent!';
        } else {
          status.textContent = res.error || 'Could not send. Try again.';
          status.style.color = '#FCA5A5';
          btn.disabled = false;
          btn.textContent = 'Send demo';
        }
      } catch {
        status.textContent = 'Network error. Try again.';
        status.style.color = '#FCA5A5';
        btn.disabled = false;
        btn.textContent = 'Send demo';
      }
    }

    document.getElementById('ob-demo-phone').addEventListener('keydown', e => {
      if (e.key === 'Enter') obSendDemo();
    });
  </script>
</body>
</html>
