<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Set up Cove</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/dash.css" />
  <style>
    /* ── Onboarding split layout ── */
    .ob-root { min-height: 100vh; display: flex; flex-direction: column; background: #F8F8FA; }

    .ob-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 2.5rem; height: 64px;
      background: #fff; border-bottom: 1px solid #E4E4E7;
      flex-shrink: 0; position: sticky; top: 0; z-index: 10;
    }
    .ob-topbar-steps {
      display: flex; align-items: center; gap: 8px;
    }
    .ob-step-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #E4E4E7; transition: all .25s;
    }
    .ob-step-dot.active { background: #2563EB; width: 28px; border-radius: 4px; }
    .ob-step-dot.done { background: #10B981; }

    .ob-split {
      flex: 1; display: grid;
      grid-template-columns: 1fr 520px;
      min-height: calc(100vh - 64px);
    }

    /* ── Left: form content ── */
    .ob-content {
      display: flex; flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
      overflow-y: auto;
      background: #fff;
    }
    .ob-form-inner { width: 100%; max-width: 440px; }
    .ob-content > * { max-width: 440px; width: 100%; }
    .ob-step-label {
      font-size: .68rem; font-weight: 700; letter-spacing: .12em;
      text-transform: uppercase; color: #2563EB; margin-bottom: .85rem;
    }
    .ob-heading {
      font-size: 2rem; font-weight: 800; letter-spacing: -.04em;
      color: #18181B; line-height: 1.15; margin-bottom: .6rem;
    }
    .ob-sub {
      font-size: .9rem; color: #71717A; line-height: 1.65;
      margin-bottom: 1.75rem;
    }

    .ob-fields { display: flex; flex-direction: column; gap: 1.25rem; }
    .ob-field label {
      display: block; font-size: .83rem; font-weight: 600;
      color: #3F3F46; margin-bottom: .45rem;
    }
    .ob-field label .optional { font-weight: 400; color: #A1A1AA; margin-left: .3rem; }
    .ob-field input, .ob-field textarea {
      width: 100%; padding: .875rem 1rem;
      font-size: 1rem; font-family: inherit;
      background: #fff; color: #18181B;
      border: 1.5px solid #E4E4E7; border-radius: 10px;
      transition: border-color .15s, box-shadow .15s;
      outline: none;
    }
    .ob-field input:focus, .ob-field textarea:focus {
      border-color: #2563EB;
      box-shadow: 0 0 0 3px rgba(37,99,235,.1);
    }
    .ob-field textarea { resize: vertical; min-height: 110px; line-height: 1.6; }
    .ob-field-hint { font-size: .8rem; color: #A1A1AA; margin-top: .4rem; line-height: 1.5; }

    .ob-actions {
      display: flex; align-items: center; justify-content: space-between;
      gap: 1rem; margin-top: 2rem;
    }
    .ob-actions--right { justify-content: flex-end; }

    .ob-error {
      font-size: .85rem; color: #EF4444;
      background: #FEF2F2; border: 1px solid #FECACA;
      border-radius: 8px; padding: .6rem .85rem;
      margin-top: 1rem; display: none;
    }
    .ob-error.visible { display: block; }

    /* ── Right: marketing sidebar ── */
    .ob-sidebar {
      background: #0F172A;
      display: flex; flex-direction: column;
      padding: 3.5rem 3.5rem;
      position: sticky; top: 64px;
      height: calc(100vh - 64px);
      overflow-y: auto;
    }
    .ob-sidebar-badge {
      display: inline-flex; align-items: center; gap: .45rem;
      font-size: .65rem; font-weight: 700; letter-spacing: .12em;
      text-transform: uppercase; color: #06B6D4;
      margin-bottom: 1.5rem;
    }
    .ob-sidebar-badge-dot {
      width: 5px; height: 5px; border-radius: 50%;
      background: #06B6D4; box-shadow: 0 0 6px #06B6D4;
      animation: pulse-dot 2s ease-in-out infinite;
    }
    @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.7)} }

    .ob-sidebar h2 {
      font-size: 1.6rem; font-weight: 800; letter-spacing: -.04em;
      color: #fff; line-height: 1.2; margin-bottom: .65rem;
    }
    .ob-sidebar-sub {
      font-size: .85rem; color: rgba(255,255,255,.38);
      line-height: 1.6; margin-bottom: 1.5rem;
    }

    .ob-stat-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: .6rem;
      margin-bottom: 1.5rem;
    }
    .ob-stat {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 10px; padding: .85rem 1rem;
    }
    .ob-stat strong {
      display: block; font-size: 1.65rem; font-weight: 900;
      letter-spacing: -.05em; color: #fff; line-height: 1;
      margin-bottom: .2rem;
    }
    .ob-stat span { font-size: .65rem; color: rgba(255,255,255,.28); line-height: 1.4; text-transform: uppercase; letter-spacing: .07em; }

    .ob-bullets { display: flex; flex-direction: column; gap: .5rem; margin-bottom: 1.5rem; }
    .ob-bullet {
      display: flex; align-items: center; gap: .65rem;
      font-size: .82rem; color: rgba(255,255,255,.45); line-height: 1.45;
    }
    .ob-bullet-icon {
      width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0;
      display: grid; place-items: center;
      background: rgba(16,185,129,.15); color: #10B981;
    }
    .ob-bullet-icon--blue { background: rgba(37,99,235,.15); color: #60A5FA; }

    .ob-sms-preview {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 12px; padding: .9rem 1rem;
      margin-top: auto; display: flex; flex-direction: column; gap: .5rem;
    }
    .ob-sms-label {
      font-size: .6rem; font-weight: 700; letter-spacing: .1em;
      text-transform: uppercase; color: rgba(255,255,255,.18);
      margin-bottom: .05rem;
    }
    .ob-bubble {
      font-size: .8rem; line-height: 1.5; padding: .45rem .7rem;
      border-radius: 12px; width: fit-content; max-width: 92%;
    }
    .ob-bubble--recv {
      background: rgba(255,255,255,.07); color: rgba(255,255,255,.75);
      border-bottom-left-radius: 3px; margin-right: auto;
    }
    .ob-bubble--sent {
      background: #2563EB; color: #fff; font-weight: 600;
      border-bottom-right-radius: 3px; margin-left: auto;
    }

    .ob-guarantee {
      display: flex; align-items: center; gap: .55rem;
      margin-top: 1rem; padding-top: 1rem;
      font-size: .75rem; color: rgba(255,255,255,.22);
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .ob-guarantee svg { color: rgba(255,255,255,.15); flex-shrink: 0; }

    /* ── AI loading state ── */
    .ob-ai-loading {
      display: flex; flex-direction: column;
      gap: 1.5rem; padding: 1.5rem 0;
    }
    .ob-ai-loading-header { display: flex; align-items: center; gap: 1rem; }
    .ob-ai-spinner {
      width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
      border: 2.5px solid #E4E4E7; border-top-color: #2563EB;
      animation: spin .75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .ob-ai-loading-text { font-size: 1.1rem; font-weight: 700; color: #18181B; letter-spacing: -.02em; }
    .ob-ai-loading-sub { font-size: .875rem; color: #71717A; margin-top: .15rem; }
    .ob-ai-loading-steps { display: flex; flex-direction: column; gap: .5rem; }
    .ob-ai-loading-step {
      font-size: .875rem; color: #A1A1AA;
      display: flex; align-items: center; gap: .65rem;
      padding: .6rem .9rem; border-radius: 8px; transition: all .2s;
    }
    .ob-ai-loading-step.active { color: #2563EB; font-weight: 600; background: #EFF6FF; }
    .ob-ai-loading-step.done { color: #10B981; }
    .ob-ai-loading-step.done svg { display: block; }
    .ob-ai-loading-step svg { display: none; }

    /* ── Flow question cards ── */
    .ob-flow-questions { display: flex; flex-direction: column; gap: .65rem; margin-bottom: 1rem; }

    .ob-q-card {
      background: #fff; border: 1.5px solid #E4E4E7; border-radius: 12px;
      overflow: hidden; transition: border-color .15s, box-shadow .15s;
    }
    .ob-q-card:focus-within { border-color: #2563EB; box-shadow: 0 0 0 3px rgba(37,99,235,.08); }

    .ob-q-card-top {
      display: flex; align-items: flex-start; gap: .75rem;
      padding: .85rem 1rem .85rem;
    }
    .ob-q-num-badge {
      width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0; margin-top: 2px;
      background: #E4E4E7; color: #71717A; font-size: .7rem; font-weight: 800;
      display: grid; place-items: center;
    }
    .ob-q-card:focus-within .ob-q-num-badge { background: #DBEAFE; color: #2563EB; }
    .ob-q-textarea {
      flex: 1; border: none; outline: none;
      font-size: .9rem; font-family: inherit;
      color: #18181B; line-height: 1.6; resize: none;
      background: transparent; overflow: hidden;
      padding: 0; min-height: unset;
    }
    .ob-q-textarea::placeholder { color: #C4C4C8; }

    .ob-q-options {
      display: flex; flex-wrap: wrap; gap: .35rem;
      padding: 0 1rem .75rem 3.1rem;
    }
    .ob-q-chip {
      display: inline-flex; align-items: center; gap: .25rem;
      font-size: .73rem; font-weight: 600; padding: .2rem .55rem;
      border-radius: 6px; background: #F4F4F5; color: #52525B; border: 1px solid #E4E4E7;
      font-family: 'SF Mono','Fira Code',monospace;
    }
    .ob-q-chip--free { background: #F0FDF4; border-color: #BBF7D0; color: #16A34A; font-family: inherit; font-weight: 500; }

    .ob-step2-hint {
      display: flex; align-items: center; gap: .5rem;
      font-size: .78rem; color: #A1A1AA; margin-bottom: .85rem;
      background: #F8F8FA; border-radius: 8px; padding: .5rem .75rem;
    }
    .ob-step2-hint svg { color: #2563EB; flex-shrink: 0; }

    .ob-regen-row { display: flex; align-items: center; gap: .75rem; margin-top: .75rem; }
    .ob-regen-btn {
      display: inline-flex; align-items: center; gap: .4rem;
      font-size: .8rem; font-weight: 600; color: #2563EB;
      background: #EFF6FF; border: 1.5px solid #BFDBFE;
      border-radius: 8px; padding: .45rem .85rem; cursor: pointer;
      font-family: inherit; transition: background .15s;
    }
    .ob-regen-btn:hover { background: #DBEAFE; }
    .ob-regen-note { font-size: .78rem; color: #A1A1AA; }

    /* ── Payment card ── */
    .ob-plan-card {
      background: #fff; border: 1.5px solid #E4E4E7; border-radius: 16px;
      overflow: hidden; margin-bottom: 1.75rem;
      box-shadow: 0 4px 16px rgba(0,0,0,.06);
    }
    .ob-plan-top {
      background: linear-gradient(135deg, #1D4ED8 0%, #0891B2 100%);
      padding: 2rem 1.75rem;
    }
    .ob-plan-price {
      font-size: 3rem; font-weight: 900; letter-spacing: -.05em;
      color: #fff; line-height: 1;
    }
    .ob-plan-price span { font-size: 1.1rem; font-weight: 500; color: rgba(255,255,255,.65); }
    .ob-plan-note { font-size: .85rem; color: rgba(255,255,255,.6); margin-top: .4rem; }
    .ob-plan-items {
      padding: 1.35rem 1.75rem; display: flex; flex-direction: column; gap: .8rem;
    }
    .ob-plan-item {
      display: flex; align-items: center; gap: .7rem;
      font-size: .9rem; color: #3F3F46;
    }
    .ob-plan-item svg { color: #10B981; flex-shrink: 0; }

    /* ── Complete step ── */
    .ob-complete-icon {
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, #2563EB, #06B6D4);
      display: grid; place-items: center; color: #fff;
      margin-bottom: 1.25rem;
      box-shadow: 0 8px 24px rgba(37,99,235,.25);
    }
    .cf-num-box {
      display: flex; align-items: center; justify-content: space-between;
      background: #fff; border: 1.5px solid #E4E4E7; border-radius: 12px;
      padding: 1rem 1.25rem; margin-bottom: 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,.04);
    }
    .cf-num-box-left { display: flex; align-items: center; gap: .75rem; }
    .cf-num-box-label { font-size: .72rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: #A1A1AA; margin-bottom: .2rem; }
    .cf-num-box-number { font-size: 1.35rem; font-weight: 800; letter-spacing: -.02em; color: #18181B; font-family: 'SF Mono','Fira Code',monospace; }
    .cf-num-box-icon { width: 38px; height: 38px; border-radius: 10px; background: #EFF6FF; display: grid; place-items: center; color: #2563EB; flex-shrink: 0; }
    .cf-num-loading { font-size: 1rem; font-weight: 600; color: #A1A1AA; font-family: inherit; }

    /* Carrier tabs */
    .cf-tabs { display: flex; gap: 6px; margin-bottom: 0; }
    .cf-tab {
      flex: 1; padding: .55rem .5rem; border-radius: 8px 8px 0 0;
      border: 1.5px solid #E4E4E7; border-bottom: none;
      background: #F4F4F5; color: #71717A;
      font-size: .8rem; font-weight: 600; cursor: pointer;
      font-family: inherit; text-align: center; transition: all .15s;
    }
    .cf-tab.active { background: #fff; color: #18181B; border-color: #E4E4E7; }
    .cf-tab-panels { border: 1.5px solid #E4E4E7; border-radius: 0 0 12px 12px; background: #fff; margin-bottom: 1.25rem; overflow: hidden; }
    .cf-panel { display: none; padding: 1.25rem; }
    .cf-panel.active { display: block; }
    .cf-panel-step { display: flex; align-items: flex-start; gap: .85rem; padding: .6rem 0; border-bottom: 1px solid #F4F4F5; }
    .cf-panel-step:last-child { border-bottom: none; padding-bottom: 0; }
    .cf-panel-num { width: 22px; height: 22px; border-radius: 50%; background: #2563EB; color: #fff; font-size: .7rem; font-weight: 800; display: grid; place-items: center; flex-shrink: 0; margin-top: 1px; }
    .cf-panel-text { font-size: .88rem; color: #3F3F46; line-height: 1.5; flex: 1; }
    .cf-panel-text strong { color: #18181B; }
    .cf-dial-btn {
      display: inline-flex; align-items: center; gap: .4rem; margin-top: .5rem;
      background: #EFF6FF; border: 1.5px solid #BFDBFE; border-radius: 8px;
      padding: .45rem .9rem; font-size: .82rem; font-weight: 700;
      color: #2563EB; font-family: 'SF Mono','Fira Code',monospace;
      text-decoration: none; cursor: pointer; letter-spacing: .03em;
      transition: background .15s;
    }
    .cf-dial-btn:hover { background: #DBEAFE; }
    .cf-dial-btn-icon { font-family: inherit; font-size: .75rem; opacity: .6; }

    .cf-code {
      display: inline-block; background: #F4F4F5; border: 1px solid #E4E4E7;
      border-radius: 6px; padding: .15rem .55rem;
      font-family: 'SF Mono', 'Fira Code', monospace; font-size: .82rem;
      color: #2563EB; font-weight: 600; letter-spacing: .02em;
    }

    .cf-test-block { border: 1.5px solid #E4E4E7; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; background: #fff; }
    .cf-test-title { font-size: .82rem; font-weight: 700; color: #3F3F46; margin-bottom: .65rem; }
    .cf-test-row { display: flex; gap: .6rem; margin-bottom: .5rem; }
    .cf-test-input { flex: 1; padding: .6rem .85rem; font-size: .9rem; font-family: inherit; border: 1.5px solid #E4E4E7; border-radius: 8px; background: #fff; color: #18181B; outline: none; }
    .cf-test-input:focus { border-color: #2563EB; }
    .cf-test-status { font-size: .82rem; font-weight: 600; min-height: 1.2rem; margin-bottom: .2rem; }
    .cf-test-status.success { color: #16A34A; }
    .cf-test-status.error { color: #DC2626; }
    .cf-test-note { font-size: .78rem; color: #A1A1AA; }

    .ob-info-banner {
      display: flex; align-items: flex-start; gap: .65rem;
      background: #F8FAFC; border: 1px solid #E4E4E7; border-radius: 10px;
      padding: .75rem 1rem; margin-top: 1rem;
      font-size: .82rem; color: #52525B; line-height: 1.5;
    }
    .ob-info-banner svg { flex-shrink: 0; margin-top: 1px; color: #A1A1AA; }

    /* ── Conversation builder ── */
    .cv-row {
      margin-bottom: 1.25rem;
    }
    .cv-label {
      display: flex; align-items: center; gap: .4rem;
      font-size: .72rem; font-weight: 600; color: #A1A1AA;
      text-transform: uppercase; letter-spacing: .06em;
      margin-bottom: .4rem;
    }
    .cv-bubble {
      background: #F8FAFC; border: 1.5px solid #E4E4E7;
      border-radius: 14px; overflow: hidden;
      transition: border-color .15s;
    }
    .cv-bubble:focus-within { border-color: #2563EB; }
    .cv-bubble--out { border-radius: 14px 14px 4px 14px; }
    .cv-bubble--q  { border-radius: 14px 14px 4px 14px; }
    .cv-textarea {
      width: 100%; box-sizing: border-box;
      background: transparent; border: none; outline: none;
      font-size: .9rem; line-height: 1.55; color: #18181B;
      font-family: inherit; resize: none; overflow: hidden;
      padding: .75rem 1rem .5rem;
      min-height: 2.4rem;
    }
    .cv-bubble-hint {
      font-size: .7rem; color: #A1A1AA;
      padding: 0 1rem .55rem; line-height: 1.4;
    }
    .cv-bubble-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: .3rem .75rem .55rem; gap: .5rem; flex-wrap: wrap;
    }
    .cv-chips { display: flex; flex-wrap: wrap; gap: .3rem; flex: 1; }
    .cv-chip {
      font-size: .7rem; font-weight: 600; color: #2563EB;
      background: #EFF6FF; border: 1px solid #BFDBFE;
      border-radius: 6px; padding: .15rem .5rem;
    }
    .cv-mode-btn {
      font-size: .68rem; font-weight: 600; font-family: inherit;
      border-radius: 6px; padding: .2rem .5rem; cursor: pointer;
      border: 1px solid #E4E4E7; background: #F4F4F5; color: #A1A1AA;
      transition: all .15s; white-space: nowrap; flex-shrink: 0;
    }
    .cv-mode-btn.free { color: #10B981; background: #F0FDF4; border-color: #BBF7D0; }
    .cv-del-btn {
      display: flex; align-items: center; gap: .25rem;
      font-size: .68rem; font-weight: 600; font-family: inherit; cursor: pointer;
      border: none; background: none; color: #EF4444; padding: .2rem .3rem;
      opacity: 0; transition: opacity .15s;
    }
    .cv-row:hover .cv-del-btn { opacity: 1; }
    .cv-reply-row {
      display: flex; justify-content: flex-end; margin-bottom: 1.25rem; margin-top: -.6rem;
    }
    .cv-reply-pill {
      display: inline-flex; align-items: center; gap: .35rem;
      background: #18181B; color: rgba(255,255,255,.7);
      font-size: .72rem; border-radius: 10px 10px 10px 2px;
      padding: .3rem .7rem; max-width: 70%;
    }
    .cv-connector {
      display: flex; align-items: center; gap: .5rem;
      margin: .3rem 0; padding-left: .5rem;
    }
    .cv-connector-line { width: 2px; height: 20px; background: #E4E4E7; margin-left: 10px; }
    .cv-add-row {
      display: flex; align-items: center; gap: .75rem; margin-top: 1rem;
    }
    .cv-add-btn {
      display: inline-flex; align-items: center; gap: .4rem;
      font-size: .82rem; font-weight: 600; font-family: inherit;
      color: #2563EB; background: #EFF6FF; border: 1.5px dashed #93C5FD;
      border-radius: 10px; padding: .55rem 1rem; cursor: pointer;
      transition: all .15s;
    }
    .cv-add-btn:hover { background: #DBEAFE; border-color: #2563EB; }
    .cv-row-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: .4rem;
    }

    /* ── iPhone mockup (ported from styles.css) ── */
    .iphone {
      width: 340px; margin: 0 auto;
      background: #000; border-radius: 44px;
      border: 3px solid #2a2a2a; overflow: hidden;
      box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset,
        0 30px 60px rgba(0,0,0,.6);
    }
    .iphone__statusbar { display:flex; justify-content:space-between; align-items:center; padding:14px 26px 0; font-size:.72rem; font-weight:600; color:#fff; }
    .iphone__statusbar-icons { display:flex; align-items:center; gap:5px; }
    .iphone__island { width:120px; height:34px; background:#000; border-radius:20px; margin:-12px auto 6px; position:relative; z-index:2; border:2px solid #1a1a1a; }
    .iphone__header { display:flex; align-items:center; gap:.5rem; padding:.45rem .85rem .55rem; background:rgba(0,0,0,.92); backdrop-filter:blur(12px); border-bottom:.5px solid rgba(255,255,255,.08); }
    .iphone__back { color:#0a84ff; display:flex; align-items:center; flex-shrink:0; }
    .iphone__contact { display:flex; align-items:center; gap:.45rem; flex:1; min-width:0; }
    .iphone__avatar { width:30px; height:30px; border-radius:50%; background:linear-gradient(135deg,#2563eb,#06b6d4); color:#fff; font-size:.55rem; font-weight:700; display:grid; place-items:center; flex-shrink:0; letter-spacing:.02em; }
    .iphone__contact-info { min-width:0; }
    .iphone__name { font-size:.82rem; font-weight:600; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .iphone__sub { font-size:.6rem; color:#8e8e93; }
    .iphone__actions { display:flex; gap:.6rem; color:#0a84ff; flex-shrink:0; }
    .iphone__screen { display:flex; flex-direction:column; padding:.25rem .65rem; min-height:280px; }
    .iphone__time { text-align:center; font-size:.63rem; font-weight:500; color:#8e8e93; padding:.6rem 0 .5rem; }
    .iphone__inputbar { display:flex; align-items:center; gap:.4rem; padding:.4rem .65rem .65rem; background:#000; border-top:.5px solid rgba(255,255,255,.08); }
    .iphone__inputbar-plus { width:28px; height:28px; border-radius:50%; background:#636366; display:grid; place-items:center; flex-shrink:0; }
    .iphone__inputbar-field { flex:1; background:transparent; border:1px solid #3a3a3c; border-radius:18px; padding:.4rem .75rem; color:#8e8e93; font-size:.78rem; font-family:inherit; }
    .iphone__inputbar-send { width:28px; height:28px; border-radius:50%; background:#0a84ff; display:grid; place-items:center; flex-shrink:0; }
    .imsg { width:fit-content; max-width:78%; padding:.5rem .75rem; border-radius:18px; font-size:.82rem; line-height:1.5; margin-bottom:.2rem; white-space:pre-line; }
    .imsg--recv { background:#1c1c1e; color:rgba(255,255,255,.92); border-bottom-left-radius:6px; margin-right:auto; }
    .imsg--sent { background:#0a84ff; color:#fff; margin-left:auto; border-bottom-right-radius:6px; font-weight:600; }
    .imsg--delivered { width:fit-content; margin-left:auto; font-size:.58rem; color:#8e8e93; padding:1px 4px 4px; }
    .iphone--hero { width:260px; border-radius:36px; border-width:2.5px; box-shadow:0 0 0 1px rgba(255,255,255,.05) inset, 0 25px 50px rgba(37,99,235,.2), 0 10px 20px rgba(0,0,0,.15); }
    .iphone--hero .iphone__statusbar { padding:10px 20px 0; font-size:.6rem; }
    .iphone--hero .iphone__statusbar-icons { gap:4px; }
    .iphone--hero .iphone__statusbar-icons svg { transform:scale(.85); }
    .iphone--hero .iphone__island { width:95px; height:27px; margin:-9px auto 4px; border-radius:16px; }
    .iphone--hero .iphone__header { padding:.35rem .7rem .4rem; gap:.4rem; }
    .iphone--hero .iphone__avatar { width:24px; height:24px; font-size:.45rem; }
    .iphone--hero .iphone__name { font-size:.7rem; }
    .iphone--hero .iphone__sub { font-size:.5rem; }
    .iphone--hero .iphone__back svg { width:8px; height:14px; }
    .iphone--hero .iphone__actions svg { width:14px; height:14px; }
    .iphone--hero .iphone__screen { display:block; height:300px; min-height:unset; padding:.2rem .55rem; overflow-y:auto; overflow-x:hidden; scroll-behavior:smooth; background:#000; position:relative; }
    .iphone--hero .iphone__screen::-webkit-scrollbar { width:0; }
    .iphone--hero .iphone__time { font-size:.52rem; padding:.4rem 0 .3rem; }
    .iphone--hero .imsg { font-size:.68rem; padding:.35rem .55rem; border-radius:16px; margin-bottom:.15rem; line-height:1.45; }
    .iphone--hero .imsg--recv { border-bottom-left-radius:5px; }
    .iphone--hero .imsg--sent { border-bottom-right-radius:5px; }
    .iphone--hero .imsg--delivered { font-size:.48rem; padding:1px 3px 3px; }
    .iphone--hero .iphone__inputbar { padding:.3rem .55rem .5rem; gap:.3rem; }
    .iphone--hero .iphone__inputbar-plus, .iphone--hero .iphone__inputbar-send { width:22px; height:22px; }
    .iphone--hero .iphone__inputbar-plus svg, .iphone--hero .iphone__inputbar-send svg { width:10px; height:10px; }
    .iphone--hero .iphone__inputbar-field { font-size:.64rem; padding:.3rem .6rem; border-radius:15px; }
    .hero-typing { display:none; align-items:center; padding:.15rem .3rem; }
    .hero-typing.show { display:flex; }
    .hero-typing__dots { display:flex; gap:2.5px; background:#1c1c1e; padding:.35rem .55rem; border-radius:16px; border-bottom-left-radius:5px; }
    .hero-typing__dot { width:5px; height:5px; background:#636366; border-radius:50%; animation:htBounce .9s ease-in-out infinite; }
    .hero-typing__dot:nth-child(2) { animation-delay:.15s; }
    .hero-typing__dot:nth-child(3) { animation-delay:.3s; }
    @keyframes htBounce { 0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-3px);opacity:1} }
    .iphone--hero .imsg:not(.show) { opacity:0; transform:translateY(8px); }
    .iphone--hero .imsg.show { animation:heroMsgIn .3s ease-out forwards; }
    @keyframes heroMsgIn { to{opacity:1;transform:translateY(0)} }
    .iphone--hero .imsg--delivered { opacity:1!important; transform:none!important; }
    .ob-notif-card { transition:opacity .5s ease, transform .5s ease; }

    /* ── Responsive ── */
    @media (max-width: 1200px) {
      .ob-split { grid-template-columns: 1fr 460px; }
      .ob-sidebar { padding: 3rem 3rem; }
    }
    @media (max-width: 1024px) {
      .ob-split { grid-template-columns: 1fr 400px; }
      .ob-sidebar { padding: 2.5rem 2.25rem; }
    }
    @media (max-width: 768px) {
      .ob-split { grid-template-columns: 1fr; }
      .ob-sidebar { display: none; }
      .ob-content { padding: 2rem 1.25rem; }
      .ob-heading { font-size: 1.7rem; }
    }
  </style>
</head>
<body class="ob-root">

  <header class="ob-topbar">
    <a href="/" class="cove-logo">
      <svg width="26" height="26" viewBox="0 0 28 28" fill="none">
        <rect width="28" height="28" rx="7" fill="url(#ob-lg)"/>
        <path d="M18 9.5a5.5 5.5 0 1 0 0 9" stroke="#fff" stroke-width="2.4" stroke-linecap="round" fill="none"/>
        <defs><linearGradient id="ob-lg" x1="0" y1="0" x2="28" y2="28"><stop stop-color="#2563eb"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs>
      </svg>
      <span>cove</span>
    </a>
    <div class="ob-topbar-steps" id="step-dots">
      <div class="ob-step-dot" data-step="1"></div>
      <div class="ob-step-dot" data-step="2"></div>
      <div class="ob-step-dot" data-step="3"></div>
      <div class="ob-step-dot" data-step="4"></div>
    </div>
    <div style="width:80px"></div>
  </header>

  <div class="ob-split">

    <!-- ── Left: form panel ── -->
    <main class="ob-content" id="ob-content">

      <!-- Step 1: Business info -->
      <div id="step-1" class="ob-form-inner">
        <div class="ob-step-label">Step 1 of 4</div>
        <h1 class="ob-heading">Tell us about your business.</h1>
        <p class="ob-sub">The more specific you are, the better Cove's AI can write your qualification questions.</p>

        <div class="ob-fields">
          <div class="ob-field">
            <label for="biz-name">Business name</label>
            <input type="text" id="biz-name" placeholder="Bay Plumbing" autocomplete="organization" />
          </div>
          <div class="ob-field">
            <label for="biz-desc">What do you do?</label>
            <textarea id="biz-desc" placeholder="e.g. We're a residential plumbing business in Sydney. We handle emergency call-outs, blocked drains, hot water systems and general repairs. Mostly homeowners and landlords." rows="4"></textarea>
            <div class="ob-field-hint">Be specific — include what types of jobs you do and who your typical customer is.</div>
          </div>
          <div class="ob-field">
            <label for="biz-booking">Online booking link <span class="optional">(optional)</span></label>
            <input type="url" id="biz-booking" placeholder="https://book.yoursite.com.au" autocomplete="url" />
          </div>
        </div>

        <div id="step1-error" class="ob-error"></div>

        <div class="ob-actions ob-actions--right" style="margin-top:2rem">
          <button class="btn btn--primary btn--lg" id="step1-next">
            Next
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Step 2a: How it works bridge -->
      <div id="step-2a" class="ob-form-inner hidden">
        <div class="ob-step-label">Step 2 of 4</div>
        <h1 class="ob-heading">Here's what Cove does.</h1>
        <p class="ob-sub">Every time someone calls and you can't pick up, this is what happens automatically — no action needed from you.</p>

        <div style="display:flex;flex-direction:column;gap:1px;margin:2rem 0">

          <div style="display:flex;gap:1.25rem;align-items:flex-start;padding:1.25rem 1.5rem;background:#F8FAFC;border:1px solid #E4E4E7;border-radius:16px 16px 4px 4px">
            <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#DBEAFE,#EFF6FF);display:grid;place-items:center;flex-shrink:0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
            </div>
            <div>
              <div style="font-weight:700;font-size:.95rem;color:#18181B;margin-bottom:.2rem">Someone calls, you miss it</div>
              <div style="font-size:.83rem;color:#71717A;line-height:1.55">Instead of going to voicemail, the call forwards to Cove. You set this up once with a 2-digit code — we'll walk you through it later.</div>
            </div>
          </div>

          <div style="display:flex;justify-content:center;padding:2px 0">
            <div style="width:2px;height:20px;background:#E4E4E7"></div>
          </div>

          <div style="display:flex;gap:1.25rem;align-items:flex-start;padding:1.25rem 1.5rem;background:#F8FAFC;border:1px solid #E4E4E7;border-radius:4px">
            <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#D1FAE5,#ECFDF5);display:grid;place-items:center;flex-shrink:0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <div>
              <div style="font-weight:700;font-size:.95rem;color:#18181B;margin-bottom:.2rem">Cove texts them back in 10 seconds</div>
              <div style="font-size:.83rem;color:#71717A;line-height:1.55">Your caller gets an SMS from your dedicated number. It asks them a few short questions — what they need, how urgent, when they want a callback.</div>
            </div>
          </div>

          <div style="display:flex;justify-content:center;padding:2px 0">
            <div style="width:2px;height:20px;background:#E4E4E7"></div>
          </div>

          <div style="display:flex;gap:1.25rem;align-items:flex-start;padding:1.25rem 1.5rem;background:#F8FAFC;border:1px solid #E4E4E7;border-radius:4px 4px 16px 16px">
            <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#FEF3C7,#FFFBEB);display:grid;place-items:center;flex-shrink:0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2" stroke-linecap="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            </div>
            <div>
              <div style="font-weight:700;font-size:.95rem;color:#18181B;margin-bottom:.2rem">You get a lead summary instantly</div>
              <div style="font-size:.83rem;color:#71717A;line-height:1.55">Once they reply, you get a text with their name, what they need and urgency. Urgent jobs flag immediately. Everything logs to your dashboard.</div>
            </div>
          </div>
        </div>

        <div style="background:#EFF6FF;border:1px solid #BFDBFE;border-radius:12px;padding:.9rem 1.1rem;display:flex;align-items:flex-start;gap:.75rem;margin-bottom:2rem">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <div style="font-size:.82rem;color:#1D4ED8;line-height:1.55">On the next screen you'll see the exact questions Cove will send. They're written for <strong id="bridge-biz-name">your business</strong> by AI — you can edit or rewrite any of them.</div>
        </div>

        <div class="ob-actions">
          <button class="btn btn--ghost" id="step2a-back" type="button">← Back</button>
          <button class="btn btn--primary btn--lg" id="step2a-next" type="button">
            See my questions
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Step 2: AI flow -->
      <div id="step-2" class="ob-form-inner hidden">
        <div class="ob-step-label">Step 2 of 4</div>
        <h1 class="ob-heading">Build your SMS conversation.</h1>
        <p class="ob-sub">This is exactly what your missed callers receive. Edit any message — watch the preview update live on the right.</p>

        <!-- Loading state -->
        <div id="flow-loading">
          <div class="ob-ai-loading">
            <div class="ob-ai-loading-header">
              <div class="ob-ai-spinner"></div>
              <div>
                <div class="ob-ai-loading-text">Writing your conversation…</div>
                <div class="ob-ai-loading-sub">Takes about 10 seconds</div>
              </div>
            </div>
            <div class="ob-ai-loading-steps">
              <div class="ob-ai-loading-step active" id="ai-step-1">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                Reading your business description
              </div>
              <div class="ob-ai-loading-step" id="ai-step-2">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                Crafting qualification questions
              </div>
              <div class="ob-ai-loading-step" id="ai-step-3">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                Formatting your SMS flow
              </div>
            </div>
          </div>
        </div>

        <!-- One-at-a-time question builder -->
        <div id="flow-content" class="hidden">

          <!-- Completed questions (stack) -->
          <div id="qb-done-list"></div>

          <!-- Active question editor -->
          <div id="qb-active" style="display:none">
            <div class="cv-label" style="margin-bottom:.5rem">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <span id="qb-active-label">Question 1</span>
            </div>
            <div class="cv-bubble cv-bubble--q" style="margin-bottom:.75rem">
              <textarea class="cv-textarea" id="qb-active-text" rows="2" placeholder="Type your question here…"></textarea>
              <div class="cv-bubble-footer">
                <div class="cv-chips" id="qb-active-chips"></div>
                <button type="button" class="cv-mode-btn" id="qb-mode-btn">⊞ A/B/C</button>
              </div>
            </div>
            <!-- Add another / Done -->
            <div style="display:flex;gap:.65rem;align-items:center;flex-wrap:wrap">
              <button class="btn btn--primary" id="qb-add-btn" type="button" style="gap:.4rem">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                Add another question
              </button>
              <button class="btn btn--ghost" id="qb-done-btn" type="button">
                That's all →
              </button>
            </div>
            <div style="font-size:.72rem;color:#A1A1AA;margin-top:.6rem" id="qb-count-hint"></div>
          </div>

          <!-- Regen link -->
          <div style="margin-top:1.25rem">
            <button class="ob-regen-btn" id="regen-btn" type="button">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
              Start over with AI
            </button>
          </div>
        </div>

        <div id="step2-error" class="ob-error"></div>

        <div class="ob-actions" style="margin-top:1.5rem" id="step2-final-actions" style="display:none">
          <button class="btn btn--ghost" id="step2-back" type="button">← Back</button>
          <button class="btn btn--primary btn--lg" id="step2-next" type="button">
            Looks good
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Step 3: Notifications -->
      <div id="step-3" class="ob-form-inner hidden">
        <div class="ob-step-label">Step 3 of 4</div>
        <h1 class="ob-heading">Where do lead summaries go?</h1>
        <p class="ob-sub">When someone completes the flow you'll get a summary — their name, what they need, and how urgent. Where should we send it?</p>

        <div class="ob-fields">
          <div class="ob-field">
            <label for="notify-phone">Your mobile number</label>
            <input type="tel" id="notify-phone" placeholder="+61 412 345 678" autocomplete="tel" />
            <div class="ob-field-hint">Summaries sent here by SMS. This is your personal number, not your business number.</div>
          </div>
          <div class="ob-field">
            <label for="notify-email">Email address <span class="optional">(optional)</span></label>
            <input type="email" id="notify-email" placeholder="you@business.com.au" autocomplete="email" />
            <div class="ob-field-hint">Also receive summaries by email. Handy for end-of-day review.</div>
          </div>
        </div>

        <div id="step3-error" class="ob-error"></div>

        <div class="ob-actions" style="margin-top:2rem">
          <button class="btn btn--ghost" id="step3-back" type="button">← Back</button>
          <button class="btn btn--primary btn--lg" id="step3-next" type="button">
            Save &amp; continue
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Step 4: Payment -->
      <div id="step-4" class="ob-form-inner hidden">
        <div class="ob-step-label">Last step</div>
        <h1 class="ob-heading">Activate your account.</h1>
        <p class="ob-sub">Add your card to go live. If Cove doesn't pay for itself in 30 days, we'll refund you in full — no questions.</p>

        <div class="ob-plan-card">
          <div class="ob-plan-top">
            <div class="ob-plan-price">$49<span>/month</span></div>
            <div class="ob-plan-note">Cancel anytime · 30-day money-back guarantee</div>
          </div>
          <div class="ob-plan-items">
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>Your own dedicated AU SMS number</div>
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>Texts leads back in 10 seconds, 24/7</div>
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>AI-qualified lead summaries to your phone</div>
            <div class="ob-plan-item"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>Webhook &amp; CRM integrations included</div>
          </div>
        </div>

        <div id="step4-error" class="ob-error"></div>

        <div class="ob-actions" style="margin-top:.5rem">
          <button class="btn btn--ghost" id="step4-back" type="button">← Back</button>
          <button class="btn btn--primary btn--lg" id="step4-pay" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            Add payment details
          </button>
        </div>

        <p style="font-size:.78rem;color:#A1A1AA;text-align:center;margin-top:1rem">
          Secured by Stripe &middot; SSL encrypted &middot; Cancel anytime
        </p>
      </div>

      <!-- Complete: call forwarding -->
      <div id="step-complete" class="ob-form-inner hidden">
        <div class="ob-complete-icon">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <h1 class="ob-heading">Set up call forwarding.</h1>
        <p class="ob-sub">Forward missed calls on your mobile to your Cove number. Takes 30 seconds. After that, every missed call sends an automatic text to your lead.</p>

        <!-- Number display -->
        <div class="cf-num-box">
          <div class="cf-num-box-left">
            <div class="cf-num-box-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </div>
            <div>
              <div class="cf-num-box-label">Your Cove number</div>
              <div class="cf-num-box-number" id="cf-number-text"><span class="cf-num-loading">Setting up…</span></div>
            </div>
          </div>
        </div>

        <!-- Carrier tabs -->
        <div class="cf-tabs">
          <button class="cf-tab active" data-tab="telstra">Telstra</button>
          <button class="cf-tab" data-tab="optus">Optus</button>
          <button class="cf-tab" data-tab="vodafone">Vodafone</button>
          <button class="cf-tab" data-tab="other">Other</button>
        </div>
        <div class="cf-tab-panels">

          <!-- Telstra -->
          <div class="cf-panel active" id="panel-telstra">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open your <strong>Phone app</strong> and go to the dial pad</div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">
                Dial this code and tap <strong>Call</strong>
                <br><a class="cf-dial-btn" id="code-1-link" href="#"><span id="code-1">**61*+XXXXXXXXXX*11*20#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">3</div>
              <div class="cf-panel-text">You'll hear a confirmation tone. Done — call forwarding is active.</div>
            </div>
          </div>

          <!-- Optus -->
          <div class="cf-panel" id="panel-optus">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open <strong>My Optus app</strong> → tap <strong>Manage</strong> → <strong>Call divert</strong></div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">Under <strong>When unanswered</strong>, enter your Cove number in local format:<br>
                <span class="cf-code" id="carrier-number-local" style="margin-top:.35rem;display:inline-block">loading…</span>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">3</div>
              <div class="cf-panel-text">Tap <strong>Save</strong>. Or try the dial code:<br>
                <a class="cf-dial-btn" id="code-2-link" href="#" style="margin-top:.35rem"><span id="code-2">**61*+XXXXXXXXXX#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
          </div>

          <!-- Vodafone -->
          <div class="cf-panel" id="panel-vodafone">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open <strong>My Vodafone app</strong> → <strong>Services</strong> → <strong>Call divert</strong></div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">Set <strong>Divert when unanswered</strong> to your Cove number:<br>
                <span class="cf-code" id="carrier-number" style="margin-top:.35rem;display:inline-block">loading…</span>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">3</div>
              <div class="cf-panel-text">Save. Or dial from the keypad:<br>
                <a class="cf-dial-btn" id="code-3-link" href="#" style="margin-top:.35rem"><span id="code-3">*61*+XXXXXXXXXX*11*20#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
          </div>

          <!-- Other -->
          <div class="cf-panel" id="panel-other">
            <div class="cf-panel-step">
              <div class="cf-panel-num">1</div>
              <div class="cf-panel-text">Open your <strong>Phone app</strong> dial pad and enter this code, then tap <strong>Call</strong>:<br>
                <a class="cf-dial-btn" id="code-4-link" href="#" style="margin-top:.35rem"><span id="code-4">**61*+XXXXXXXXXX*11*20#</span> <span class="cf-dial-btn-icon">↗</span></a>
              </div>
            </div>
            <div class="cf-panel-step">
              <div class="cf-panel-num">2</div>
              <div class="cf-panel-text">If that fails, call your carrier and say: <em>"Set call divert when unanswered to <span id="other-number">your Cove number</span>"</em></div>
            </div>
          </div>

        </div>

        <!-- Test SMS -->
        <div class="cf-test-block">
          <div class="cf-test-title">Test it — send yourself an SMS</div>
          <div class="cf-test-row">
            <input type="tel" id="cf-test-phone" placeholder="Your mobile e.g. 0412 345 678" class="cf-test-input" />
            <button class="btn btn--primary btn--sm" id="cf-test-btn" type="button">Send</button>
          </div>
          <div class="cf-test-status" id="cf-test-status"></div>
          <div class="cf-test-note">If you receive it, your Cove number is working.</div>
        </div>

        <div class="ob-info-banner">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
          <span>Your number is saved in your dashboard. Questions? <a href="mailto:hello@coveplatform.com" style="color:#2563EB;font-weight:600">hello@coveplatform.com</a></span>
        </div>

        <div class="ob-actions ob-actions--right" style="margin-top:1.75rem">
          <button class="btn btn--primary btn--lg" id="go-dashboard" type="button">
            Go to dashboard
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

    </main>

    <!-- ── Right: marketing sidebar ── -->
    <aside class="ob-sidebar" id="ob-sidebar">

      <!-- Default sidebar (steps 1-3) -->
      <div id="sidebar-default" style="display:flex;flex-direction:column;height:100%;align-items:center;justify-content:center;gap:1.5rem">

        <div style="text-align:center">
          <div class="ob-sidebar-badge" style="justify-content:center;margin-bottom:.75rem">
            <span class="ob-sidebar-badge-dot"></span>
            Live in 10 seconds
          </div>
          <div style="font-size:1.5rem;font-weight:900;letter-spacing:-.04em;color:#fff;line-height:1.15">
            What your customer gets.
          </div>
          <div style="font-size:.82rem;color:rgba(255,255,255,.35);margin-top:.4rem">
            The moment you miss a call — this lands on their phone.
          </div>
        </div>

        <!-- iPhone mockup -->
        <div style="position:relative">
          <div class="iphone iphone--hero">
            <div class="iphone__statusbar">
              <span>9:41</span>
              <div class="iphone__statusbar-icons">
                <svg width="16" height="11" viewBox="0 0 16 11" fill="#fff"><rect y="3.5" width="3" height="7.5" rx=".8" opacity=".3"/><rect x="4.3" y="1.5" width="3" height="9.5" rx=".8" opacity=".55"/><rect x="8.6" y="0" width="3" height="11" rx=".8" opacity=".8"/><rect x="12.9" y="0" width="3" height="11" rx=".8"/></svg>
                <svg width="15" height="11" viewBox="0 0 15 11" fill="none" stroke="#fff" stroke-width="1.2"><path d="M1.5 7.5C3.5 3 6.5 1 7.5 1s4 2 6 6.5" opacity=".3"/><path d="M3.5 7C5 4 6.5 2.5 7.5 2.5S10 4 11.5 7" opacity=".6"/><path d="M5.5 7C6.2 5 7 4 7.5 4s1.3 1 2 3"/><circle cx="7.5" cy="8.5" r="1.2" fill="#fff" stroke="none"/></svg>
                <svg width="24" height="11" viewBox="0 0 24 11" fill="none"><rect x=".5" y=".5" width="20" height="10" rx="2.5" stroke="#fff" stroke-opacity=".35"/><rect x="21.5" y="3" width="1.5" height="5" rx=".75" fill="#fff" opacity=".4"/><rect x="1.5" y="1.5" width="15" height="8" rx="1.5" fill="#fff"/></svg>
              </div>
            </div>
            <div class="iphone__island"></div>
            <div class="iphone__header">
              <div class="iphone__back"><svg width="10" height="17" viewBox="0 0 10 17" fill="none" stroke="#0a84ff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 1L2 8.5 9 16"/></svg></div>
              <div class="iphone__contact">
                <div class="iphone__avatar" id="ob-iphone-avatar">BP</div>
                <div class="iphone__contact-info">
                  <div class="iphone__name" id="ob-iphone-name">Bay Plumbing</div>
                  <div class="iphone__sub">SMS</div>
                </div>
              </div>
              <div class="iphone__actions">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              </div>
            </div>
            <div class="iphone__screen" id="ob-iphone-screen">
              <div class="iphone__time">Today 9:41 AM</div>
              <div class="hero-typing" id="ob-iphone-typing"><div class="hero-typing__dots"><div class="hero-typing__dot"></div><div class="hero-typing__dot"></div><div class="hero-typing__dot"></div></div></div>
            </div>
            <div class="iphone__inputbar">
              <div class="iphone__inputbar-plus"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg></div>
              <div class="iphone__inputbar-field">Text Message</div>
              <div class="iphone__inputbar-send"><svg width="13" height="13" viewBox="0 0 24 24" fill="#fff"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></div>
            </div>
          </div>

          <!-- Notification card -->
          <div class="ob-notif-card" id="ob-iphone-notif" style="opacity:0;transform:translateY(12px);width:260px;margin-top:.75rem">
            <div style="text-align:center;font-size:.58rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:#06B6D4;margin-bottom:.35rem">↓ Sent to your phone instantly</div>
            <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:.65rem .75rem .6rem;backdrop-filter:blur(12px)">
              <div style="display:flex;align-items:center;gap:.35rem;margin-bottom:.3rem">
                <svg width="18" height="18" viewBox="0 0 28 28" fill="none"><rect width="28" height="28" rx="7" fill="url(#ob-nlg)"/><path d="M18 8a7 7 0 1 0 0 12" stroke="#fff" stroke-width="2.4" stroke-linecap="round"/><defs><linearGradient id="ob-nlg" x1="0" y1="0" x2="28" y2="28"><stop stop-color="#2563eb"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
                <span style="font-size:.58rem;font-weight:600;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.04em">Cove</span>
                <span style="margin-left:auto;font-size:.52rem;color:rgba(255,255,255,.35)">now</span>
              </div>
              <div style="font-size:.7rem;font-weight:700;color:#fff;margin-bottom:.15rem">🚨 New Urgent Lead</div>
              <div style="font-size:.62rem;line-height:1.5;color:rgba(255,255,255,.55)">Sam Thompson — Burst pipe<br>Urgency: Emergency · Call back ASAP</div>
            </div>
            <div style="text-align:center;font-size:.56rem;color:rgba(255,255,255,.3);margin-top:.35rem;letter-spacing:.02em;font-weight:500">Delivered via SMS + Email · No app needed</div>
          </div>
        </div>

        <!-- Demo input -->
        <div style="width:260px;background:rgba(37,99,235,.15);border:1px solid rgba(37,99,235,.4);border-radius:14px;padding:1rem 1.1rem">
          <div style="font-size:.72rem;font-weight:700;color:rgba(255,255,255,.65);margin-bottom:.5rem">Try it — text yourself the demo</div>
          <div style="display:flex;gap:.4rem">
            <input id="ob-demo-phone" type="tel" placeholder="0412 345 678" style="flex:1;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:.5rem .75rem;font-size:.82rem;color:#fff;font-family:inherit;outline:none;min-width:0" />
            <button id="ob-demo-btn" type="button" onclick="obSendDemo()" style="background:#2563EB;color:#fff;border:none;border-radius:8px;padding:.5rem .85rem;font-size:.78rem;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;flex-shrink:0">Send</button>
          </div>
          <div id="ob-demo-status" style="font-size:.72rem;margin-top:.4rem;min-height:1rem;color:rgba(255,255,255,.45)"></div>
        </div>

      </div>

      <!-- Sidebar for step 2: live phone preview -->
      <div id="sidebar-step2" style="display:none;flex-direction:column;height:100%">
        <div class="ob-sidebar-badge">
          <span class="ob-sidebar-badge-dot"></span>
          Live preview
        </div>

        <div style="font-size:1.6rem;font-weight:900;letter-spacing:-.04em;color:#fff;line-height:1.15;margin-bottom:.6rem">
          What your customer sees.
        </div>
        <div style="font-size:.85rem;color:rgba(255,255,255,.35);line-height:1.6;margin-bottom:1.75rem">
          This is the exact SMS conversation they receive within 10 seconds of a missed call.
        </div>

        <!-- Phone shell -->
        <div style="flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:1.25rem;display:flex;flex-direction:column;overflow:hidden">
          <!-- Fake SMS header -->
          <div style="display:flex;align-items:center;gap:.65rem;padding-bottom:.85rem;margin-bottom:.85rem;border-bottom:1px solid rgba(255,255,255,.07)">
            <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#2563eb,#06b6d4);display:grid;place-items:center;font-size:.7rem;font-weight:800;color:#fff" id="sidebar-step2-avatar">BP</div>
            <div>
              <div style="font-size:.82rem;font-weight:700;color:#fff" id="sidebar-step2-name">Bay Plumbing</div>
              <div style="font-size:.68rem;color:rgba(255,255,255,.3)">SMS · Delivered instantly</div>
            </div>
          </div>

          <!-- Messages — populated by JS -->
          <div id="sidebar-step2-msgs" style="display:flex;flex-direction:column;gap:.5rem;overflow-y:auto;flex:1">
            <div style="background:rgba(255,255,255,.05);color:rgba(255,255,255,.3);font-size:.78rem;padding:.65rem .85rem;border-radius:10px;text-align:center">
              Your questions will appear here as they load…
            </div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:rgba(255,255,255,.18);padding-top:1.1rem;margin-top:1.1rem;border-top:1px solid rgba(255,255,255,.06)">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          Updates live as you edit questions above
        </div>
      </div>

      <!-- Sidebar for payment step -->
      <div id="sidebar-payment" style="display:none;flex-direction:column;height:100%">
        <div class="ob-sidebar-badge">
          <span class="ob-sidebar-badge-dot"></span>
          Last step
        </div>

        <div style="font-size:2.2rem;font-weight:900;letter-spacing:-.05em;color:#fff;line-height:1.1;margin-bottom:1rem">
          One job covers<br/><span style="color:#06B6D4">6 months.</span>
        </div>

        <div style="font-size:.85rem;color:rgba(255,255,255,.35);line-height:1.6;margin-bottom:2rem">
          Average trade job is $400+. Cove is $49/mo. The maths is simple.
        </div>

        <div style="flex:1;display:flex;flex-direction:column;justify-content:flex-end">
          <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:1.5rem;margin-bottom:1.25rem">
            <div style="font-size:3rem;font-weight:900;letter-spacing:-.06em;color:#fff;line-height:1">$49</div>
            <div style="font-size:.8rem;color:rgba(255,255,255,.35);margin-top:.3rem;margin-bottom:1.5rem">per month · cancel anytime</div>
            <div style="display:flex;flex-direction:column;gap:.6rem">
              <div style="display:flex;align-items:center;gap:.6rem;font-size:.82rem;color:rgba(255,255,255,.55)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                AU number activated immediately
              </div>
              <div style="display:flex;align-items:center;gap:.6rem;font-size:.82rem;color:rgba(255,255,255,.55)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                No setup fee, no contracts
              </div>
              <div style="display:flex;align-items:center;gap:.6rem;font-size:.82rem;color:rgba(255,255,255,.55)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
                30-day money-back guarantee
              </div>
            </div>
          </div>

          <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:1.1rem 1.25rem">
            <div style="font-size:.82rem;color:rgba(255,255,255,.6);font-style:italic;line-height:1.6;margin-bottom:.5rem">"Leads are qualified before I finish the current job."</div>
            <div style="font-size:.72rem;font-weight:600;color:rgba(255,255,255,.25)">Mark T. — Bay Area Plumbing</div>
          </div>

          <div style="display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:rgba(255,255,255,.2);padding-top:1rem;margin-top:1rem;border-top:1px solid rgba(255,255,255,.06)">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Secured by Stripe · SSL encrypted
          </div>
        </div>
      </div>

    </aside>
  </div>

  <script>
    let currentStep = 1;
    let flowConfig = null;
    let bizData = {};

    function showStep(n) {
      document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.add('hidden'));
      const el = document.getElementById('step-' + n);
      if (el) el.classList.remove('hidden');

      // Update dots — treat '2a' as step 2
      const stepNum = n === '2a' ? 2 : (typeof n === 'number' ? n : 5);
      document.querySelectorAll('.ob-step-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'done');
        const s = i + 1;
        if (s < stepNum) dot.classList.add('done');
        else if (s === stepNum) dot.classList.add('active');
      });
      currentStep = n;

      // Swap sidebar
      const sidebarDefault  = document.getElementById('sidebar-default');
      const sidebarStep2    = document.getElementById('sidebar-step2');
      const sidebarPayment  = document.getElementById('sidebar-payment');
      sidebarDefault.style.display  = 'none';
      sidebarStep2.style.display    = 'none';
      sidebarPayment.style.display  = 'none';
      if (n === 2) {
        sidebarStep2.style.display = 'flex';
        // Update avatar initials and name
        const name = bizData.businessName || '';
        const initials = name.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase() || 'BP';
        const av = document.getElementById('sidebar-step2-avatar');
        const nm = document.getElementById('sidebar-step2-name');
        if (av) av.textContent = initials;
        if (nm) nm.textContent = name || 'Your business';
      } else if (n === 4) {
        sidebarPayment.style.display = 'flex';
      } else {
        sidebarDefault.style.display = 'flex';
      }

      // Scroll form to top
      document.getElementById('ob-content').scrollTo(0, 0);
    }

    // ─── Init ───
    const params = new URLSearchParams(location.search);
    if (params.get('step') === 'complete') {
      showStep('complete');
      // Try to fill number immediately from session, then fall back to polling
      fetch('/api/auth/me').then(r => r.json()).then(data => {
        const num = data.business?.twilio_from_number;
        if (num) { fillNumber(num); }
        else { loadNumber(); }
      }).catch(() => loadNumber());
    } else if (params.get('step') === 'billing') {
      showStep(4);
    } else {
      fetch('/api/auth/me')
        .then(r => r.json())
        .then(data => {
          if (!data.ok) { location.href = '/login'; return; }
          if (data.user?.onboarding_complete && data.business?.is_active) {
            location.href = '/dashboard'; return;
          }
          if (data.business?.name) {
            bizData.businessName = data.business.name;
            document.getElementById('biz-name').value = data.business.name;
          }
          showStep(1);
        })
        .catch(() => location.href = '/login');
    }

    let _loadNumberAttempts = 0;
    let _provisionAttempted = false;

    function fillNumber(num) {
      const numBox = document.getElementById('cf-number-text');
      if (numBox) numBox.textContent = num;

      const localNum = num.startsWith('+61') ? '0' + num.slice(3) : num;
      const intlNum  = num.startsWith('+')   ? '0011' + num.slice(1) : num;

      const codes = {
        'code-1': `**61*${num}*11*20#`,
        'code-2': `**61*${num}#`,
        'code-3': `*61*${num}*11*20#`,
        'code-4': `**61*${intlNum}*11*20#`,
      };
      for (const [id, code] of Object.entries(codes)) {
        const el = document.getElementById(id);
        if (el) el.textContent = code;
        const link = document.getElementById(id + '-link');
        if (link) link.href = `tel:${encodeURIComponent(code)}`;
      }
      const cn = document.getElementById('carrier-number');
      if (cn) cn.textContent = num;
      const ln = document.getElementById('carrier-number-local');
      if (ln) ln.textContent = localNum;
      const on = document.getElementById('other-number');
      if (on) on.textContent = num;
    }

    // ─── Carrier tabs ───
    document.querySelectorAll('.cf-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.cf-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.cf-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        const panel = document.getElementById('panel-' + tab.dataset.tab);
        if (panel) panel.classList.add('active');
      });
    });

    async function loadNumber() {
      _loadNumberAttempts++;
      const numText = document.getElementById('cf-number-text');
      try {
        const data = await fetch('/api/auth/me').then(r => r.json());
        const num = data.business?.twilio_from_number;
        if (num) { fillNumber(num); return; }
      } catch(e) { /* network error, retry */ }

      // After 3 polls (~9s) with no number, auto-trigger provision once
      if (!_provisionAttempted && _loadNumberAttempts >= 3) {
        _provisionAttempted = true;
        if (numText) numText.textContent = 'Provisioning your number…';
        try {
          const r = await fetch('/api/auth/provision-number', { method: 'POST' }).then(r => r.json());
          if (r.ok && r.number) { fillNumber(r.number); return; }
        } catch(e) { /* fall through to retry loop */ }
      }

      if (_loadNumberAttempts < 15) {
        const secs = _loadNumberAttempts * 3;
        if (numText) numText.textContent = `Setting up your number… (${secs}s)`;
        setTimeout(loadNumber, 3000);
      } else {
        if (numText) numText.innerHTML = `Could not provision automatically — <a href="#" id="retry-provision" style="color:#2563EB;font-weight:600">try again</a> or <a href="mailto:hello@coveplatform.com" style="color:#2563EB">contact support</a>.`;
        document.getElementById('retry-provision')?.addEventListener('click', async (e) => {
          e.preventDefault();
          _loadNumberAttempts = 0; _provisionAttempted = false;
          if (numText) numText.textContent = 'Retrying…';
          loadNumber();
        });
      }
    }

    // ─── Test SMS ───
    const testBtn = document.getElementById('cf-test-btn');
    if (testBtn) {
      testBtn.addEventListener('click', async () => {
        const phone = document.getElementById('cf-test-phone').value.trim();
        const status = document.getElementById('cf-test-status');
        if (!phone) { status.textContent = 'Enter your mobile number first.'; status.className = 'cf-test-status error'; return; }
        testBtn.disabled = true; testBtn.textContent = 'Sending…';
        status.textContent = ''; status.className = 'cf-test-status';
        try {
          const res = await fetch('/api/demo/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, message: `✅ Cove is connected! Your call forwarding is set up correctly. Missed calls will now be texted back automatically.` })
          }).then(r => r.json());
          if (res.ok) {
            status.textContent = '✅ Test SMS sent! Check your phone — if you got it, you\'re all set.';
            status.className = 'cf-test-status success';
          } else {
            status.textContent = res.error || 'Could not send — check your number and try again.';
            status.className = 'cf-test-status error';
          }
        } catch(e) {
          status.textContent = 'Network error — try again.';
          status.className = 'cf-test-status error';
        }
        testBtn.disabled = false; testBtn.textContent = 'Send test SMS';
      });
    }

    // ─── AI loading animation ───
    function animateAISteps() {
      const steps = ['ai-step-1', 'ai-step-2', 'ai-step-3'];
      let i = 0;
      function advance() {
        if (i > 0) {
          const prev = document.getElementById(steps[i - 1]);
          if (prev) { prev.classList.remove('active'); prev.classList.add('done'); }
        }
        if (i < steps.length) {
          const cur = document.getElementById(steps[i]);
          if (cur) cur.classList.add('active');
          i++;
          if (i < steps.length) setTimeout(advance, 1200);
        }
      }
      // Reset
      steps.forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.classList.remove('active', 'done'); }
      });
      setTimeout(advance, 400);
    }

    // ─── One-at-a-time Question Builder ───
    // qbSteps: array of committed step objects
    // qbActiveIdx: index being edited right now
    let qbSteps = [];
    let qbActiveIdx = 0;

    function mkBubble(text, sent) {
      const d = document.createElement('div');
      d.style.cssText = sent
        ? 'background:#0a84ff;color:#fff;font-size:.65rem;line-height:1.45;padding:.35rem .55rem;border-radius:14px;border-bottom-right-radius:4px;margin-bottom:.25rem;margin-left:auto;width:fit-content;max-width:82%;font-weight:600;white-space:pre-line'
        : 'background:#1c1c1e;color:rgba(255,255,255,.88);font-size:.65rem;line-height:1.45;padding:.35rem .55rem;border-radius:14px;border-bottom-left-radius:4px;margin-bottom:.25rem;margin-right:auto;width:fit-content;max-width:82%;white-space:pre-line';
      d.textContent = text;
      return d;
    }

    // Render the "done" stack above the active question
    function qbRenderDoneList() {
      const list = document.getElementById('qb-done-list');
      list.innerHTML = '';
      qbSteps.forEach((step, i) => {
        const row = document.createElement('div');
        row.style.cssText = 'margin-bottom:.75rem';
        const isFree = !!step.free_text;
        const replyText = isFree
          ? (step.options[0]?.label || 'Sure')
          : (step.options[0] ? step.options[0].value + ') ' + step.options[0].label : 'A');

        row.innerHTML = `
          <div class="cv-label" style="margin-bottom:.3rem;justify-content:space-between">
            <span style="display:flex;align-items:center;gap:.4rem">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
              Question ${i + 1}
            </span>
            <button type="button" style="font-size:.68rem;font-weight:600;color:#2563EB;background:none;border:none;cursor:pointer;font-family:inherit;padding:0" data-edit="${i}">Edit</button>
          </div>
          <div style="background:#F0FDF4;border:1px solid #BBF7D0;border-radius:12px 12px 4px 12px;padding:.6rem .85rem;font-size:.85rem;color:#18181B;line-height:1.5;margin-bottom:.3rem">${step.question || '<em style="color:#A1A1AA">Empty question</em>'}</div>
          <div style="display:flex;justify-content:flex-end">
            <div class="cv-reply-pill" style="font-size:.7rem">${replyText}</div>
          </div>
        `;
        row.querySelector('[data-edit]').addEventListener('click', () => qbEditStep(i));
        list.appendChild(row);
      });

      // Connector line to active question
      if (qbSteps.length > 0) {
        const line = document.createElement('div');
        line.className = 'cv-connector-line';
        line.style.marginBottom = '8px';
        list.appendChild(line);
      }
    }

    // Load a step into the active editor
    function qbLoadActive(idx) {
      qbActiveIdx = idx;
      const step = flowConfig.steps[idx];
      const activeEl = document.getElementById('qb-active');
      const labelEl  = document.getElementById('qb-active-label');
      const ta       = document.getElementById('qb-active-text');
      const chipsEl  = document.getElementById('qb-active-chips');
      const modeBtn  = document.getElementById('qb-mode-btn');
      const hint     = document.getElementById('qb-count-hint');

      activeEl.style.display = 'block';
      labelEl.textContent = `Question ${idx + 1}`;

      ta.value = step.question || '';
      ta.style.height = 'auto';
      ta.style.height = (ta.scrollHeight || 56) + 'px';

      const isFree = !!step.free_text;
      modeBtn.dataset.modefree = isFree;
      modeBtn.classList.toggle('free', isFree);
      modeBtn.textContent = isFree ? '✎ Free text' : '⊞ A/B/C';

      chipsEl.innerHTML = isFree
        ? '<span style="font-size:.7rem;color:#A1A1AA">Customer types freely</span>'
        : step.options.map(o => `<span class="cv-chip">${o.value}) ${o.label}</span>`).join('');

      const total = flowConfig.steps.length;
      hint.textContent = idx === 0
        ? 'You can add up to 5 questions. Most businesses use 3.'
        : `${total} question${total !== 1 ? 's' : ''} so far. Add more or finish.`;

      updateSidebarPreview();
      ta.focus();
    }

    // Commit current active question and optionally advance
    function qbCommitActive() {
      const ta = document.getElementById('qb-active-text');
      const modeBtn = document.getElementById('qb-mode-btn');
      const q = ta.value.trim();
      if (!q) return false;
      if (!flowConfig.steps[qbActiveIdx]) return false;
      flowConfig.steps[qbActiveIdx].question = q;
      flowConfig.steps[qbActiveIdx].free_text = modeBtn.dataset.modefree === 'true';
      return true;
    }

    // Edit a committed step
    function qbEditStep(idx) {
      // Commit current if valid
      qbCommitActive();
      // Remove steps after idx from committed list
      qbSteps = flowConfig.steps.slice(0, idx);
      qbRenderDoneList();
      qbLoadActive(idx);
      // Hide final actions
      document.getElementById('step2-final-actions').style.display = 'none';
      document.getElementById('qb-active').style.display = 'block';
    }

    // Add another question button
    document.getElementById('qb-add-btn').addEventListener('click', () => {
      if (!qbCommitActive()) return;
      qbSteps = flowConfig.steps.slice(0, qbActiveIdx + 1);

      // Add a new blank step after current if not already there
      const nextIdx = qbActiveIdx + 1;
      if (!flowConfig.steps[nextIdx]) {
        flowConfig.steps.push({
          id: 'q_' + Date.now(), key: 'q_' + Date.now(),
          question: '', invalid_text: 'Please reply A, B or C.',
          options: [{ value: 'A', label: 'Option A' }, { value: 'B', label: 'Option B' }],
          urgent_values: [], free_text: false,
        });
      }

      qbRenderDoneList();
      qbLoadActive(nextIdx);
    });

    // I'm done button
    document.getElementById('qb-done-btn').addEventListener('click', () => {
      if (!qbCommitActive()) {
        document.getElementById('qb-active-text').style.outline = '2px solid #EF4444';
        setTimeout(() => document.getElementById('qb-active-text').style.outline = '', 1200);
        return;
      }
      qbSteps = flowConfig.steps.slice(0, qbActiveIdx + 1);
      // Trim any trailing empty steps
      flowConfig.steps = qbSteps;
      qbRenderDoneList();
      document.getElementById('qb-active').style.display = 'none';
      document.getElementById('step2-final-actions').style.display = 'flex';
      updateSidebarPreview();
    });

    // Mode toggle (A/B/C ↔ free text) on active question
    document.getElementById('qb-mode-btn').addEventListener('click', function() {
      const nowFree = this.dataset.modefree !== 'true';
      this.dataset.modefree = nowFree;
      this.classList.toggle('free', nowFree);
      this.textContent = nowFree ? '✎ Free text' : '⊞ A/B/C';
      const step = flowConfig.steps[qbActiveIdx];
      const chipsEl = document.getElementById('qb-active-chips');
      if (nowFree) {
        chipsEl.innerHTML = '<span style="font-size:.7rem;color:#A1A1AA">Customer types freely</span>';
      } else {
        chipsEl.innerHTML = step.options.map(o => `<span class="cv-chip">${o.value}) ${o.label}</span>`).join('');
      }
      updateSidebarPreview();
    });

    // Active textarea — live resize + preview
    document.getElementById('qb-active-text').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
      if (flowConfig?.steps[qbActiveIdx]) flowConfig.steps[qbActiveIdx].question = this.value;
      updateSidebarPreview();
    });

    function renderFlow(flow) {
      qbSteps = [];
      qbActiveIdx = 0;
      document.getElementById('qb-done-list').innerHTML = '';
      document.getElementById('step2-final-actions').style.display = 'none';
      qbLoadActive(0);
      updateSidebarPreview();
    }

    // ─── Live sidebar preview (iPhone) ───
    function updateSidebarPreview() {
      const msgs = document.getElementById('sidebar-step2-msgs');
      if (!msgs) return;
      msgs.innerHTML = '';
      const bizName = bizData.businessName || 'Your Business';

      // Intro from flowConfig
      if (flowConfig?.intro) {
        const rendered = flowConfig.intro.replace(/{firstName}/g, 'Sam').replace(/{businessName}/g, bizName);
        msgs.appendChild(mkBubble(rendered, false));
      }

      // Committed questions + replies
      const allDone = [...qbSteps];
      // Also include the current active if it has content
      const activeTa = document.getElementById('qb-active-text');
      const activeQ = activeTa?.value.trim();
      const modeBtn = document.getElementById('qb-mode-btn');

      allDone.forEach((step, i) => {
        if (!step.question?.trim()) return;
        msgs.appendChild(mkBubble(step.question, false));
        const reply = step.free_text
          ? (step.options[0]?.label || 'Sure')
          : (step.options[0] ? step.options[0].value + ') ' + step.options[0].label : 'A');
        msgs.appendChild(mkBubble(reply, true));
      });

      // Current active question being typed
      if (activeQ && document.getElementById('qb-active')?.style.display !== 'none') {
        msgs.appendChild(mkBubble(activeQ, false));
        const isFree = modeBtn?.dataset.modefree === 'true';
        const step = flowConfig?.steps[qbActiveIdx];
        const reply = isFree
          ? (step?.options[0]?.label || 'Sure')
          : (step?.options[0] ? step.options[0].value + ') ' + step.options[0].label : 'A');
        // Show reply as greyed "typing" indicator
        const typing = document.createElement('div');
        typing.style.cssText = 'display:flex;justify-content:flex-end;margin-bottom:.25rem';
        typing.innerHTML = `<div style="background:#0a84ff;opacity:.4;color:#fff;font-size:.6rem;padding:.3rem .55rem;border-radius:12px;border-bottom-right-radius:3px">${reply}</div>`;
        msgs.appendChild(typing);
      }

      msgs.scrollTop = msgs.scrollHeight;
    }

    // ─── Step 1 → 2a (bridge) ───
    document.getElementById('step1-next').addEventListener('click', () => {
      const name = document.getElementById('biz-name').value.trim();
      const desc = document.getElementById('biz-desc').value.trim();
      const err = document.getElementById('step1-error');
      err.classList.remove('visible');

      if (!name) { err.textContent = 'Please enter your business name.'; err.classList.add('visible'); return; }
      if (!desc || desc.length < 20) { err.textContent = 'Please describe your business in a bit more detail (at least 20 characters).'; err.classList.add('visible'); return; }

      bizData = { ...bizData, businessName: name, description: desc, bookingLink: document.getElementById('biz-booking').value.trim() };

      // Update bridge screen with business name
      const bridgeName = document.getElementById('bridge-biz-name');
      if (bridgeName) bridgeName.textContent = name;

      showStep('2a');
    });

    // ─── Step 2a → 2 (trigger AI generation) ───
    document.getElementById('step2a-back').addEventListener('click', () => showStep(1));
    document.getElementById('step2a-next').addEventListener('click', async () => {
      const btn = document.getElementById('step2a-next');
      btn.disabled = true;
      btn.innerHTML = 'Writing questions… <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';

      showStep(2);
      document.getElementById('flow-loading').classList.remove('hidden');
      document.getElementById('flow-content').classList.add('hidden');
      animateAISteps();

      const res = await fetch('/api/onboarding/generate-flow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ businessName: bizData.businessName, description: bizData.description }),
      }).then(r => r.json());

      btn.disabled = false;
      btn.innerHTML = 'See my questions <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';

      document.getElementById('flow-loading').classList.add('hidden');

      if (res.ok) {
        flowConfig = res.flow;
        renderFlow(flowConfig);
        document.getElementById('flow-content').classList.remove('hidden');
      } else {
        const stepErr = document.getElementById('step2-error');
        stepErr.textContent = res.error || 'Could not generate questions. Please check your OpenAI key.';
        stepErr.classList.add('visible');
        document.getElementById('flow-content').classList.remove('hidden');
      }
    });

    document.getElementById('regen-btn').addEventListener('click', async () => {
      document.getElementById('flow-loading').classList.remove('hidden');
      document.getElementById('flow-content').classList.add('hidden');
      animateAISteps();

      const res = await fetch('/api/onboarding/generate-flow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ businessName: bizData.businessName, description: bizData.description }),
      }).then(r => r.json());

      document.getElementById('flow-loading').classList.add('hidden');
      if (res.ok) {
        flowConfig = res.flow;
        renderFlow(flowConfig);
      }
      document.getElementById('flow-content').classList.remove('hidden');
    });

    // ─── Step 2 → 3 ───
    document.getElementById('step2-back').addEventListener('click', () => showStep('2a'));
    document.getElementById('step2-next').addEventListener('click', () => {
      if (flowConfig) {
        // flowConfig.steps is kept up-to-date by the qb state machine
        bizData.flowConfig = flowConfig;
      }
      showStep(3);
    });

    // ─── Step 3 → 4 ───
    document.getElementById('step3-back').addEventListener('click', () => showStep(2));
    document.getElementById('step3-next').addEventListener('click', async () => {
      const phone = document.getElementById('notify-phone').value.trim();
      const email = document.getElementById('notify-email').value.trim();
      const err = document.getElementById('step3-error');
      err.classList.remove('visible');

      if (!phone) { err.textContent = 'Please enter your mobile number.'; err.classList.add('visible'); return; }

      bizData = { ...bizData, notifyPhone: phone, notifyEmail: email };

      const btn = document.getElementById('step3-next');
      btn.disabled = true;
      btn.textContent = 'Saving…';

      const res = await fetch('/api/onboarding/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          businessName: bizData.businessName,
          flowConfig: bizData.flowConfig || null,
          notifyPhone: phone,
          notifyEmail: email || null,
          bookingLink: bizData.bookingLink || null,
        }),
      }).then(r => r.json());

      btn.disabled = false;
      btn.innerHTML = 'Save &amp; continue <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';

      if (res.ok) {
        showStep(4);
      } else {
        err.textContent = res.error || 'Could not save. Please try again.';
        err.classList.add('visible');
      }
    });

    // ─── Step 4 → Stripe (or free bypass in dev) ───
    document.getElementById('step4-back').addEventListener('click', () => showStep(3));

    async function startCheckout() {
      const btn = document.getElementById('step4-pay');
      const err = document.getElementById('step4-error');
      btn.disabled = true;
      btn.textContent = 'Setting up your account…';
      err.classList.remove('visible');

      const res = await fetch('/api/billing/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      }).then(r => r.json());

      if (res.ok && res.url) {
        location.href = res.url;
      } else {
        err.textContent = res.error || 'Could not start checkout. Please try again.';
        err.classList.add('visible');
        btn.disabled = false;
        btn.innerHTML = originalPayBtnHtml;
      }
    }

    const payBtn = document.getElementById('step4-pay');
    const originalPayBtnHtml = payBtn.innerHTML;

    // Check if Stripe is configured — update button label accordingly
    fetch('/api/config/stripe-mode').then(r => r.json()).then(res => {
      if (!res.stripeEnabled) {
        payBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Activate account (free trial)`;
        document.querySelector('#step-4 .ob-sub').textContent = 'Click below to activate your account and get your dedicated number set up.';
      }
    }).catch(() => {});

    payBtn.addEventListener('click', startCheckout);

    // ─── Complete → Dashboard ───
    document.getElementById('go-dashboard').addEventListener('click', () => {
      location.href = '/dashboard';
    });

    // ─── Sidebar iPhone animation ───
    function runObIphoneAnim() {
      const screen   = document.getElementById('ob-iphone-screen');
      const typing   = document.getElementById('ob-iphone-typing');
      const notif    = document.getElementById('ob-iphone-notif');
      if (!screen || !typing) return;

      const msgs = [
        { cls: 'imsg--recv', text: 'Hi Sam — thanks for calling Bay Plumbing.\n\nHow urgent is this?\nA) Emergency  B) Same day  C) Can wait' },
        { cls: 'imsg--sent', text: 'A' },
        { cls: 'imsg--delivered', text: '✓ Delivered' },
        { cls: 'imsg--recv', text: 'Got it — emergency. What\'s the issue?\n1) Leak / burst pipe  2) Blocked drain\n3) Hot water  4) Other' },
        { cls: 'imsg--sent', text: '1' },
        { cls: 'imsg--delivered', text: '✓ Delivered' },
        { cls: 'imsg--recv', text: 'Thanks Sam! We\'ll have someone call you back within the hour. 🔧' },
      ];

      // Clear old messages (keep time div)
      [...screen.querySelectorAll('.imsg')].forEach(el => el.remove());
      typing.classList.remove('show');
      if (notif) { notif.style.opacity = '0'; notif.style.transform = 'translateY(12px)'; }

      let i = 0;
      function next() {
        if (i >= msgs.length) {
          // Show notification card
          if (notif) {
            setTimeout(() => {
              notif.style.opacity = '1';
              notif.style.transform = 'translateY(0)';
            }, 600);
          }
          // Loop after delay
          setTimeout(runObIphoneAnim, 6000);
          return;
        }
        const m = msgs[i];
        const isRecv = m.cls === 'imsg--recv';
        // Show typing before recv messages
        if (isRecv) {
          typing.classList.add('show');
          screen.appendChild(typing); // move to end
          screen.scrollTop = screen.scrollHeight;
          setTimeout(() => {
            typing.classList.remove('show');
            addMsg();
          }, 900);
        } else {
          addMsg();
        }
      }
      function addMsg() {
        const m = msgs[i];
        const div = document.createElement('div');
        div.className = `imsg ${m.cls}`;
        div.textContent = m.text;
        screen.insertBefore(div, typing);
        requestAnimationFrame(() => div.classList.add('show'));
        screen.scrollTop = screen.scrollHeight;
        i++;
        setTimeout(next, m.cls === 'imsg--delivered' ? 200 : 700);
      }
      setTimeout(next, 500);
    }

    // Start animation once page is ready
    window.addEventListener('load', () => setTimeout(runObIphoneAnim, 800));

    // Update iPhone header live as user types business name
    document.getElementById('biz-name').addEventListener('input', function() {
      const name = this.value.trim();
      const initials = name.split(' ').map(w => w[0]).filter(Boolean).join('').slice(0,2).toUpperCase() || 'BP';
      const av = document.getElementById('ob-iphone-avatar');
      const nm = document.getElementById('ob-iphone-name');
      if (av) av.textContent = initials;
      if (nm) nm.textContent = name || 'Bay Plumbing';
    });

    // ─── Sidebar demo widget ───
    async function obSendDemo() {
      const input = document.getElementById('ob-demo-phone');
      const btn   = document.getElementById('ob-demo-btn');
      const status = document.getElementById('ob-demo-status');
      const phone = input.value.trim();
      if (!phone) { status.textContent = 'Enter your mobile number first.'; status.style.color = '#FCA5A5'; return; }
      btn.disabled = true;
      btn.textContent = 'Sending…';
      status.textContent = '';
      try {
        const res = await fetch('/api/demo/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone }),
        }).then(r => r.json());
        if (res.ok) {
          status.textContent = '✓ SMS sent — reply to the questions!';
          status.style.color = '#6EE7B7';
          btn.textContent = 'Sent!';
        } else {
          status.textContent = res.error || 'Could not send. Try again.';
          status.style.color = '#FCA5A5';
          btn.disabled = false;
          btn.textContent = 'Send demo';
        }
      } catch {
        status.textContent = 'Network error. Try again.';
        status.style.color = '#FCA5A5';
        btn.disabled = false;
        btn.textContent = 'Send demo';
      }
    }

    document.getElementById('ob-demo-phone').addEventListener('keydown', e => {
      if (e.key === 'Enter') obSendDemo();
    });
  </script>
</body>
</html>
